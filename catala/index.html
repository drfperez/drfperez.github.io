<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <title>Apr√®n Catal√†: Data i Hora</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 30px; }
    #clock { width: 300px; height: 300px; border: 10px solid #333; border-radius: 50%;
             position: relative; margin: 0 auto 20px auto; background: white; }
    .hand { position: absolute; top: 50%; left: 50%; transform-origin: 0% 50%;
             transform: rotate(-90deg); transition: transform 0.5s ease-in-out; }
    #hour-hand { width: 35%; height: 6px; background: #000; }
    #minute-hand { width: 45%; height: 4px; background: red; }
    #center-dot { width: 12px; height: 12px; background: #000; border-radius: 50%;
                  position: absolute; top: calc(50% - 6px); left: calc(50% - 6px); z-index: 10; }
    .number { position: absolute; width: 30px; height: 30px; text-align: center;
               line-height: 30px; font-weight: bold; transform: translate(-50%, -50%); }
    #time-text, #date-text { font-size: 1.3em; margin-top: 10px; min-height: 40px; }
    #inputs { margin-bottom: 20px; }
    input, button, select { padding: 6px; margin: 3px; font-size: 1em; }
    #voice-info { margin-top: 10px; font-size: 0.9em; color: #555; }
  </style>
</head>
<body>
  <h1>üìö Apr√®n Catal√† amb la Data i l'Hora</h1>
  <div id="inputs">
    <button onclick="setNow()">Ara mateix</button><br>
    <input type="number" id="hour-input" min="0" max="23" placeholder="Hora (0‚Äì23)">
    <input type="number" id="minute-input" min="0" max="59" placeholder="Minut"><br>
    <input type="date" id="date-input"><br>
    <select id="day-select"></select>
    <select id="month-select"></select>
    <input type="number" id="year-input" min="1" max="3000" placeholder="Any"><br>
    <button onclick="setCustom()">Actualitza</button>
    <button onclick="speakAll()">üîä Escolta</button>
  </div>
  <div id="clock">
    <div id="hour-hand" class="hand"></div>
    <div id="minute-hand" class="hand"></div>
    <div id="center-dot"></div>
  </div>
  <div id="date-text"></div>
  <div id="time-text"></div>
  <div id="voice-info">S'estan carregant les veus...</div>

  <script>
    // ------------------- Configuraci√≥ TTS -------------------
    let voices = [];
    let hasCatalanVoice = false;
    let useResponsiveVoice = false;
    
    // Funci√≥ per carregar ResponsiveVoice des del CDN
    function loadResponsiveVoice() {
      return new Promise((resolve, reject) => {
        if (typeof responsiveVoice !== 'undefined') {
          resolve();
          return;
        }
        
        const script = document.createElement('script');
        script.src = 'https://code.responsivevoice.org/responsivevoice.js?key=HYPef5G5';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }
    
    // Detectar veus disponibles
    function loadVoices() {
      return new Promise((resolve) => {
        const synth = window.speechSynthesis;
        voices = synth.getVoices();
        
        if (voices.length !== 0) {
          checkCatalanVoices();
          resolve();
        } else {
          synth.onvoiceschanged = () => {
            voices = synth.getVoices();
            checkCatalanVoices();
            resolve();
          };
        }
      });
    }
    
    function checkCatalanVoices() {
      const synth = window.speechSynthesis;
      voices = synth.getVoices();
      hasCatalanVoice = voices.some(voice => voice.lang.includes('ca'));
      
      const voiceInfo = document.getElementById('voice-info');
      
      if (hasCatalanVoice) {
        voiceInfo.textContent = 'S\'ha detectat suport per a veu en catal√† al navegador.';
      } else {
        voiceInfo.textContent = 'No s\'ha detectat veu en catal√† al navegador. S\'utilitzar√† un servei extern.';
        
        // Carregar ResponsiveVoice com a alternativa
        loadResponsiveVoice().then(() => {
          useResponsiveVoice = true;
          voiceInfo.textContent += ' Servei extern carregat correctament.';
        }).catch(() => {
          voiceInfo.textContent += ' Error en carregar el servei extern.';
        });
      }
    }
    
    // Inicialitzar veus
    window.addEventListener('DOMContentLoaded', () => {
      loadVoices();
    });

    // ------------------- Rellotge -------------------
    const clock = document.getElementById('clock');
    const radius = 140;
    for (let i = 1; i <= 12; i++) {
      const angle = (i * 30 - 90) * Math.PI / 180;
      const x = 150 + radius * Math.cos(angle);
      const y = 150 + radius * Math.sin(angle);
      const number = document.createElement('div');
      number.className = 'number';
      number.innerText = i;
      number.style.left = `${x}px`;
      number.style.top = `${y}px`;
      clock.appendChild(number);
    }

    function numeroEnLletres(n) {
      return ['zero','una','dues','tres','quatre','cinc','sis','set','vuit','nou','deu','onze','dotze'][n];
    }
    function deHora(num) {
      const str = numeroEnLletres(num);
      return ['a','e','i','o','u'].includes(str[0]) ? `d'${str}` : `de ${str}`;
    }
    function prefixDia(h) {
      if (h >= 6 && h < 12) return 'del mat√≠';
      if (h >= 12 && h < 18) return 'de la tarda';
      if (h >= 18 && h < 22) return 'del vespre';
      return 'de la nit';
    }

    function formatHoraCatalana(h, m) {
      const h12 = h % 12 || 12;
      const next = h12 % 12 + 1;
      const baseHora = numeroEnLletres(h12);
      const horaSeguent = numeroEnLletres(next);
      const dia = prefixDia(h);

      if (m === 0) return (h12 === 1 ? '√âs la ' : 'S√≥n les ') + baseHora + ' en punt ' + dia;
      if (m === 15) return '√âs un quart ' + deHora(next) + ' ' + dia;
      if (m === 30) return 'S√≥n dos quarts ' + deHora(next) + ' ' + dia;
      if (m === 45) return 'S√≥n tres quarts ' + deHora(next) + ' ' + dia;

      if (m >= 7 && m <= 8) return '√âs mig quart ' + deHora(next) + ' ' + dia;
      if (m >= 22 && m <= 23) return '√âs un quart i mig ' + deHora(next) + ' ' + dia;
      if (m >= 37 && m <= 38) return 'S√≥n dos quarts i mig ' + deHora(next) + ' ' + dia;
      if (m >= 52 && m <= 53) return 'S√≥n tres quarts i mig ' + deHora(next) + ' ' + dia;

      const quarts = [
        { min: 15, text: 'un quart ' + deHora(next) },
        { min: 30, text: 'dos quarts ' + deHora(next) },
        { min: 45, text: 'tres quarts ' + deHora(next) },
        { min: 60, text: 'les ' + horaSeguent }
      ];

      let proper = quarts.find(q => m < q.min);
      let anterior = quarts[quarts.indexOf(proper) - 1] || { min: 0, text: baseHora };

      const diffNext = proper.min - m;
      const diffPrev = m - anterior.min;

      if (diffNext <= 5) {
        return `Falten ${diffNext} minut${diffNext===1?'':'s'} per a ${proper.text} ${dia}`;
      } else {
        return `Passen ${diffPrev} minut${diffPrev===1?'':'s'} de ${anterior.text} ${dia}`;
      }
    }

    function updateClock(h, m) {
      let h12 = h % 12 || 12;
      const hourAngle = ((h12 % 12) + m / 60) * 30 - 90;
      const minuteAngle = m * 6 - 90;
      document.getElementById('hour-hand').style.transform = `rotate(${hourAngle}deg)`;
      document.getElementById('minute-hand').style.transform = `rotate(${minuteAngle}deg)`;
      document.getElementById('time-text').innerText = formatHoraCatalana(h, m);
    }

    // ------------------- Data -------------------
    const dies = ['diumenge','dilluns','dimarts','dimecres','dijous','divendres','dissabte'];
    const mesos = ['de gener','de febrer','de mar√ß','d\'abril','de maig','de juny','de juliol','d\'agost','de setembre','d\'octubre','de novembre','de desembre'];

    function numeroOrdinals(n) {
      const lletres = ['zero','un','dos','tres','quatre','cinc','sis','set','vuit','nou','deu',
        'onze','dotze','tretze','catorze','quinze','setze','disset','divuit','dinou','vint',
        'vint-i-un','vint-i-dos','vint-i-tres','vint-i-quatre','vint-i-cinc','vint-i-sis',
        'vint-i-set','vint-i-vuit','vint-i-nou','trenta','trenta-u'];
      return lletres[n];
    }

    function anyEnLletres(any) {
      const milers = Math.floor(any / 1000);
      const centenars = any % 1000;
      let resultat = '';
      if (milers === 1) resultat = 'mil';
      else if (milers === 2) resultat = 'dos mil';
      else if (milers === 3) resultat = 'tres mil';
      else resultat = any; // simplificaci√≥ si √©s m√©s gran

      if (centenars > 0) {
        resultat += ' ' + numeroOrdinals(centenars);
      }
      return resultat;
    }

    function formatData(d) {
      const diaSetmana = dies[d.getDay()];
      const diaMes = numeroOrdinals(d.getDate());
      const mes = mesos[d.getMonth()];
      const any = anyEnLletres(d.getFullYear());
      return `Avui √©s ${diaSetmana}, ${diaMes} ${mes} de ${any}`;
    }

    // ------------------- Control -------------------
    function setNow() {
      const now = new Date();
      updateClock(now.getHours(), now.getMinutes());
      document.getElementById('date-text').innerText = formatData(now);
    }

    function setCustom() {
      const h = parseInt(document.getElementById('hour-input').value, 10);
      const m = parseInt(document.getElementById('minute-input').value, 10);
      const dateStr = document.getElementById('date-input').value;
      const daySel = document.getElementById('day-select').value;
      const monthSel = document.getElementById('month-select').value;
      const yearVal = parseInt(document.getElementById('year-input').value, 10);

      if (!isNaN(h) && !isNaN(m)) updateClock(h, m);

      let d;
      if (dateStr) d = new Date(dateStr);
      else if (daySel && monthSel && yearVal) d = new Date(yearVal, monthSel, daySel);
      if (d) document.getElementById('date-text').innerText = formatData(d);
    }

    // ------------------- Veu -------------------
    function speakAll() {
      const text = document.getElementById('date-text').innerText + ". " + document.getElementById('time-text').innerText;
      if (!text) return;
      
      if (useResponsiveVoice && typeof responsiveVoice !== 'undefined') {
        // Utilitzar ResponsiveVoice com a alternativa
        responsiveVoice.speak(text, "Catalan Female", {rate: 0.9});
      } else if (hasCatalanVoice) {
        // Utilitzar la s√≠ntesi de veu del navegador
        const utterance = new SpeechSynthesisUtterance(text);
        const catalanVoice = voices.find(voice => voice.lang.includes('ca'));
        if (catalanVoice) {
          utterance.voice = catalanVoice;
        }
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
      } else {
        // Si no hi ha cap opci√≥ de TTS disponible
        document.getElementById('voice-info').textContent = 
          'No s\'ha pogut carregar cap veu en catal√†. Si us plau, actualitzi el seu navegador.';
      }
    }

    // ------------------- Inicialitzaci√≥ -------------------
    // Omplir desplegables
    const daySelect = document.getElementById('day-select');
    for (let i = 1; i <= 31; i++) {
      let opt = document.createElement('option');
      opt.value = i;
      opt.textContent = i;
      daySelect.appendChild(opt);
    }
    const monthSelect = document.getElementById('month-select');
    mesos.forEach((m, i) => {
      let opt = document.createElement('option');
      opt.value = i;
      opt.textContent = m.replace('de ','').replace('d\'','');
      monthSelect.appendChild(opt);
    });

    setNow();
    const now = new Date();
    const msToNext = (60 - now.getSeconds()) * 1000;
    setTimeout(() => {
      setNow();
      setInterval(setNow, 60 * 1000);
    }, msToNext);
  </script>
</body>
</html>
