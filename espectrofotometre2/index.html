
<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lowry — Cerca màxim + Recta patró (LDR 0–1023)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; padding:16px; background:#f3f4f6;}
.card{max-width:900px; margin:auto; background:white; padding:16px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.1);} 
.row{display:flex; flex-wrap:wrap; gap:12px; align-items:center;}
label{font-weight:600;}
input[type=range]{flex:1;}
.result{background:#eef2ff; padding:10px; border-radius:8px;}
#chartWrap{position:relative; height:380px;}

/* Cubeta Lowry (1 cm, estilitzada) */
#cuvetteWrap{display:flex; align-items:center; gap:12px; margin:12px 0;}
#cuvette{
  width:120px; height:60px;
  border:2px solid #555;
  border-radius:6px;
  background:rgba(30,144,255,0.2);
  transition:background 0.2s linear;
}
#cuvetteLabel{font-size:0.9rem; color:#444;}

/* Mini-espectre per trobar el màxim */
#scanCanvas{width:100%; height:200px;}
#scanBox{margin-bottom:16px;}
</style>
</head>
<body>
<div class="card">
<h2>1) Cerca del màxim d’absorbància (simulador previ)</h2>
<p>Simulem un espectre Lowry amb un màxim real prop de <b>660 nm</b>. El botó fa un “scan” visual i estima el pic.</p>

<div id="scanBox">
  <button onclick="simulateScan()">Cerca màxim (simulat)</button>
  <span id="scanResult" style="margin-left:10px"></span>
  <canvas id="scanCanvas" width="900" height="200"></canvas>
</div>

<hr/>

<h2>2) Recta patró (LDR 0–1023) i interpolació</h2>
<p>La <b>"absorbància" = lectura directa del LDR (0–1023)</b>. En moure el control, el punt es projecta sobre la recta, es calcula mg/L i <b>la intensitat del blau de la cubeta canvia</b>.</p>

<div class="row">
<label for="ldr">Lectura LDR:</label>
<input id="ldr" type="range" min="0" max="1023" value="400" oninput="updateFromInput()" />
<input id="ldrNum" type="number" min="0" max="1023" value="400" style="width:90px" oninput="updateFromInput()" />
</div>

<div id="cuvetteWrap">
  <div id="cuvette"></div>
  <div id="cuvetteLabel">Cubeta Lowry (1 cm) — intensitat blau ∝ LDR</div>
</div>

<div class="result" style="margin:12px 0">
<b>Resultat estimat:</b>
<div id="out"></div>
</div>

<div id="chartWrap">
<canvas id="calibChart"></canvas>
</div>
</div>

<script>
// ==================== PART 1: SIMULADOR DE SCAN (TROBAR EL MÀXIM) ====================
const scanCanvas = document.getElementById('scanCanvas');
const sctx = scanCanvas.getContext('2d');
const scanResult = document.getElementById('scanResult');

function drawEmptySpectrum(){
  sctx.clearRect(0,0,scanCanvas.width,scanCanvas.height);
  sctx.strokeStyle = '#ccc'; sctx.lineWidth = 1;
  sctx.beginPath();
  sctx.moveTo(40,10); sctx.lineTo(40,scanCanvas.height-30);
  sctx.lineTo(scanCanvas.width-10,scanCanvas.height-30);
  sctx.stroke();
  sctx.fillStyle='#666'; sctx.font='12px system-ui';
  sctx.fillText('380 nm',40,scanCanvas.height-10);
  sctx.fillText('740 nm',scanCanvas.width-70,scanCanvas.height-10);
}

drawEmptySpectrum();

function simulatedAbsorbance(w){
  // Pic real prop de 660 nm (Lowry)
  const peak = 660;
  const width = 35;
  const amp = Math.exp(-0.5*Math.pow((w-peak)/width,2));
  const noise = 0.02*Math.sin(w/20);
  return amp*0.95 + noise;
}

function simulateScan(){
  scanResult.textContent = 'Escanejant...';
  sctx.clearRect(0,0,scanCanvas.width,scanCanvas.height);
  drawEmptySpectrum();

  const wmin=380, wmax=740;
  const steps = 180;
  const padL=40, padR=10, padT=10, padB=30;
  const W=scanCanvas.width, H=scanCanvas.height;
  const plotW = W-padL-padR;
  const plotH = H-padT-padB;

  let maxA = -1;
  let maxW = 0;

  sctx.beginPath();
  for(let i=0;i<=steps;i++){
    const w = wmin + (wmax-wmin)*i/steps;
    const A = simulatedAbsorbance(w);
    if(A>maxA){ maxA=A; maxW=w; }
    const x = padL + plotW*(i/steps);
    const y = padT + plotH*(1-A);
    if(i===0) sctx.moveTo(x,y); else sctx.lineTo(x,y);
  }
  sctx.strokeStyle = '#1e90ff'; sctx.lineWidth = 2;
  sctx.stroke();

  // Marcar el màxim trobat
  const tx = padL + plotW*((maxW-wmin)/(wmax-wmin));
  const ty = padT + plotH*(1-maxA);
  sctx.fillStyle='red';
  sctx.beginPath(); sctx.arc(tx,ty,5,0,2*Math.PI); sctx.fill();

  scanResult.textContent = `Màxim estimat ≈ ${Math.round(maxW)} nm (esperat ~660 nm)`;
}

// ==================== PART 2: RECTA PATRÓ + INTERPOLACIÓ ====================
// --- DADES DE CALIBRATGE (simulades però coherents) ---
const calib = [
  [0, 0],
  [200, 5],
  [400, 12],
  [600, 18],
  [800, 25]
];

// Regressió lineal y = m*x + b
const a = calib.map(p=>p[0]);
const b = calib.map(p=>p[1]);
const n = a.length;
const sumX = a.reduce((s,v)=>s+v,0);
const sumY = b.reduce((s,v)=>s+v,0);
const sumXY = a.reduce((s,v,i)=>s+v*b[i],0);
const sumX2 = a.reduce((s,v)=>s+v*v,0);
const m = (n*sumXY - sumX*sumY)/(n*sumX2 - sumX*sumX);
const b0 = (sumY - m*sumX)/n;

// R^2
const yMean = sumY/n;
const ssTot = b.reduce((s,yi)=>s+(yi-yMean)**2,0);
const ssRes = a.reduce((s,xi,i)=>s+(b[i]-(m*xi+b0))**2,0);
const R2 = 1 - ssRes/ssTot;

// Preparar línia de regressió (0-1023)
const linePts = [];
for(let x=0;x<=1023;x+=102){ linePts.push({x, y:m*x + b0}); }

const ctx = document.getElementById('calibChart').getContext('2d');
const chart = new Chart(ctx,{
  type:'scatter',
  data:{
    datasets:[
      {label:'Patrons', data:calib.map(p=>({x:p[0],y:p[1]})), pointRadius:5},
      {label:'Recta patró', data:linePts, type:'line', fill:false, pointRadius:0},
      {label:'Mostra', data:[{x:400,y:m*400+b0}], pointRadius:7}
    ]
  },
  options:{
    animation:false,
    responsive:true,
    maintainAspectRatio:false,
    plugins:{title:{display:true, text:`y = ${m.toFixed(4)}·x + ${b0.toFixed(2)}  |  R² = ${R2.toFixed(4)}`}},
    scales:{
      x:{title:{display:true,text:'Lectura LDR (0–1023)'}, min:0, max:1023},
      y:{title:{display:true,text:'Concentració (mg/L)'}, beginAtZero:true}
    }
  }
});

function updateFromInput(){
  const slider = document.getElementById('ldr');
  const num = document.getElementById('ldrNum');
  let x = Math.max(0, Math.min(1023, Number(slider.value)));
  num.value = x;

  const y = m*x + b0;
  chart.data.datasets[2].data = [{x, y}];
  chart.update();

  document.getElementById('out').innerHTML = `LDR = <b>${x}</b> → mg/L ≈ <b>${y.toFixed(2)}</b>`;

  // --- Canvi d'intensitat del blau de la cubeta ---
  const frac = x/1023; // 0 → transparent, 1 → molt blau
  const cuv = document.getElementById('cuvette');
  cuv.style.background = `rgba(30,144,255,${(0.15 + 0.85*frac).toFixed(3)})`;
}

updateFromInput();
</script>
</body>
</html>
