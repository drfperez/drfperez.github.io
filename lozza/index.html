<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Escacs</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            background: #1a1a1a;
            overflow: hidden;
            font-family: sans-serif;
            touch-action: manipulation;
        }

        #board-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #board {
            width: 95vmin;
            height: 95vmin;
            max-width: 100vw;
            max-height: 88vh;
        }

        .panel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(34, 34, 34, 0.95);
            padding: 6px 0;
            box-sizing: border-box;
            text-align: center;
            color: white;
            z-index: 10;
        }

        .compact-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            padding: 0 8px;
        }

        select, button, .nav-btn, .icon-btn {
            padding: 0;
            width: 42px;
            height: 42px;
            font-size: 24px;
            border-radius: 6px;
            border: none;
            background: #2ecc71;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        select {
            background: white;
            font-size: 20px;
        }

        .nav-btn {
            background: #34495e;
            color: white;
        }

        .nav-btn:disabled {
            background: #555;
            opacity: 0.5;
            cursor: not-allowed;
        }

        .icon-btn {
            background: #3498db;
            color: white;
            font-size: 20px;
        }

        .file-label {
            width: 42px;
            height: 42px;
            background: #3498db;
            color: white;
            font-size: 20px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-label input { display: none; }

        button:hover, .nav-btn:hover:not(:disabled), select:hover {
            opacity: 0.9;
        }

        .status {
            font-weight: bold;
            margin: 6px 0 4px;
            color: #2ecc71;
            font-size: 16px;
            min-height: 24px;
            padding: 0 10px;
        }
    </style>
</head>
<body>

    <div id="board-container">
        <div id="board"></div>

        <div class="panel">
            <div class="compact-row">
                <select id="side-select" title="Costat">
                    <option value="w">‚ôî</option>
                    <option value="b">‚ôö</option>
                </select>
                <select id="difficulty-select" title="Dificultat">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3" selected>3</option>
                    <option value="4">4</option>
                </select>
                <button class="icon-btn" id="flip-btn" title="Girar tauler">‚ÜîÔ∏è</button>
                <button class="icon-btn" id="new-game-btn" title="Nova partida">‚Ü∫</button>
                <button class="icon-btn" id="save-pgn-btn" title="Desar">üíæ</button>
                <label class="file-label" title="Carregar">üìÇ
                    <input type="file" id="load-pgn-file" accept=".pgn,text/plain">
                </label>
                <button class="icon-btn" id="load-example-btn" title="Immortal Game comentada">‚òÖ</button>
            </div>

            <div class="compact-row navigation">
                <button class="nav-btn" id="start-btn" title="Inici">‚èÆ</button>
                <button class="nav-btn" id="prev-btn" title="Endarrere">‚óÄ</button>
                <span id="move-number" style="min-width:50px; color:#2ecc71; font-weight:bold;">0</span>
                <button class="nav-btn" id="next-btn" title="Endavant">‚ñ∂</button>
                <button class="nav-btn" id="end-btn" title="Final">‚è≠</button>
            </div>

            <div id="status" class="status">Prem ‚Ü∫ per nova partida o ‚òÖ per la Immortal Game comentada</div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

    <script>
        let game = null;
        let board = null;
        let playerSide = 'w';
        let difficulty = 3;
        let thinking = false;
        let history = [];
        let currentIndex = 0;
        let isImmortalGame = false;

        const immortalComments = [
            "Posici√≥ inicial. Les blanques comencen.",
            "1.e4 ‚Äì Obertura est√†ndard.",
            "1...e5 ‚Äì Resposta sim√®trica.",
            "2.f4 ‚Äì Gambit de rei! Anderssen ofereix un pe√≥ per atac r√†pid.",
            "2...exf4 ‚Äì Kieseritzky accepta el gambit.",
            "3.Bc4 ‚Äì Desenvolupament r√†pid apuntant a f7.",
            "3...Qh4+ ‚Äì Xeic agressiu molt aviat.",
            "4.Kf1 ‚Äì El rei es mou per no perdre temps.",
            "4...b5!? ‚Äì Contraatac arriscat oferint un pe√≥.",
            "5.Bxb5 ‚Äì Anderssen accepta i guanya material.",
            "5...Nf6 ‚Äì Desenvolupa i amena√ßa e4.",
            "6.Nf3 ‚Äì Ataca la dama negra.",
            "6...Qh6 ‚Äì La dama es retira.",
            "7.d3 ‚Äì Protegeix el pe√≥ central.",
            "7...Nh5 ‚Äì Amena√ßa el cavall blanc.",
            "8.Nh4 ‚Äì Nova amena√ßa a la dama.",
            "8...Qg5",
            "9.Nf5 ‚Äì Cavall al centre.",
            "9...c6 ‚Äì Ataca l'alfil blanc.",
            "10.g4!? ‚Äì Sacrifici espectacular: ofereix una torre!",
            "10...Nf6",
            "11.Rg1 ‚Äì La torre es posa en joc i es continua oferint.",
            "11...cxb5 ‚Äì Acceptat el sacrifici.",
            "12.h4 ‚Äì Atac directe a la dama.",
            "12...Qg6",
            "13.h5 ‚Äì For√ßa la dama a moure's de nou.",
            "13...Qg5",
            "14.Qf3 ‚Äì Desenvolupa la dama amb amena√ßa.",
            "14...Ng8 ‚Äì Defensa passiva.",
            "15.Bxf4 ‚Äì Recupera el pe√≥ amb bon desenvolupament.",
            "15...Qf6",
            "16.Nc3 ‚Äì L'altre cavall entra en joc.",
            "16...Bc5",
            "17.Nd5!? ‚Äì Sacrifici de cavall brillant.",
            "17...Qxb2 ‚Äì Acceptat.",
            "18.Bd6! ‚Äì Sacrifici de les dues torres!",
            "18...Bxg1",
            "19.e5 ‚Äì Obra l√≠nies centrals.",
            "19...Qxa1+",
            "20.Ke2 ‚Äì El rei camina cap al centre sense por.",
            "20...Na6",
            "21.Nxg7+! ‚Äì Xeic descobert amb el cavall.",
            "21...Kd8",
            "22.Qf6+! ‚Äì Sacrifici de dama!",
            "22...Nxf6",
            "23.Be7# ‚Äì Mat immortal! Una de les partides m√©s belles de la hist√≤ria."
        ];

        function getCurrentComment() {
            if (isImmortalGame && currentIndex < immortalComments.length) {
                return immortalComments[currentIndex];
            }
            return null;
        }

        function getLastMoveSAN() {
            const moves = game.history();
            if (moves.length === 0) return "";
            return moves[moves.length - 1];
        }

        function updateStatus() {
            if (thinking) {
                document.getElementById('status').innerText = "Pensant...";
                return;
            }

            const comment = getCurrentComment();
            if (comment) {
                document.getElementById('status').innerText = comment;
                return;
            }

            const lastMove = getLastMoveSAN();
            if (lastMove) {
                document.getElementById('status').innerText = lastMove;
                return;
            }

            if (game.in_checkmate()) {
                const winner = game.turn() === 'w' ? 'Negres' : 'Blanques';
                document.getElementById('status').innerText = `Mat! ${winner} guanyen`;
            } else if (game.in_draw()) {
                document.getElementById('status').innerText = "Taules";
            } else if (game.in_check()) {
                document.getElementById('status').innerText = "Escac!";
            } else if (game.turn() === playerSide) {
                document.getElementById('status').innerText = "El teu torn";
            } else {
                document.getElementById('status').innerText = "";
            }
        }

        function updateMoveNumber() {
            document.getElementById('move-number').innerText = currentIndex;
        }

        function updateNavButtons() {
            document.getElementById('start-btn').disabled = currentIndex <= 0;
            document.getElementById('prev-btn').disabled = currentIndex <= 0;
            document.getElementById('next-btn').disabled = currentIndex >= history.length - 1;
            document.getElementById('end-btn').disabled = currentIndex >= history.length - 1;
            updateMoveNumber();
        }

        function goToIndex(index) {
            if (index < 0 || index >= history.length) return;
            currentIndex = index;
            game.load(history[currentIndex]);
            board.position(game.fen(), false);
            updateNavButtons();
            updateStatus();
        }

        function flipBoard() {
            if (board) {
                board.flip();
            }
        }

        function makeAIMove() {
            if (thinking || game.game_over() || game.turn() === playerSide) return;
            thinking = true;
            updateStatus();

            setTimeout(() => {
                const bestMove = findBestMove(game);
                if (bestMove) {
                    game.move(bestMove);
                    history.push(game.fen());
                    currentIndex = history.length - 1;
                    board.position(game.fen(), false);
                }
                thinking = false;
                updateStatus();
                updateNavButtons();
            }, 100);
        }

        function onDrop(source, target) {
            if (thinking || game.turn() !== playerSide) return 'snapback';

            const move = game.move({
                from: source,
                to: target,
                promotion: 'q'
            });

            if (move === null) return 'snapback';

            history.push(game.fen());
            currentIndex = history.length - 1;
            board.position(game.fen(), false);
            updateNavButtons();
            updateStatus();
            makeAIMove();
        }

        function onSnapEnd() {
            board.position(game.fen());
        }

        function initBoard(orientation) {
            const config = {
                draggable: true,
                position: game.fen(),
                orientation: orientation,
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
                onDrop: onDrop,
                onSnapEnd: onSnapEnd
            };
            if (board) board.destroy();
            board = ChessBoard('board', config);
        }

        function startNewGame() {
            game = new Chess();
            history = [game.fen()];
            currentIndex = 0;
            isImmortalGame = false;
            playerSide = document.getElementById('side-select').value;
            difficulty = parseInt(document.getElementById('difficulty-select').value);

            initBoard(playerSide === 'w' ? 'white' : 'black');
            updateNavButtons();
            updateStatus();

            if (playerSide !== 'w') makeAIMove();
        }

        // Bot√≥ Flip ‚Äì ara amb emoji m√©s visible ‚ÜîÔ∏è
        document.getElementById('flip-btn').addEventListener('click', flipBoard);

        // Bot√≥ ‚òÖ Immortal Game
        document.getElementById('load-example-btn').addEventListener('click', () => {
            const pgn = `[Event "La Partida Immortal"]
[Site "London 1851"]
[White "Adolf Anderssen"]
[Black "Lionel Kieseritzky"]
[Result "1-0"]

1. e4 e5 2. f4 exf4 3. Bc4 Qh4+ 4. Kf1 b5 5. Bxb5 Nf6 6. Nf3 Qh6 7. d3 Nh5 8. Nh4 Qg5
9. Nf5 c6 10. g4 Nf6 11. Rg1 cxb5 12. h4 Qg6 13. h5 Qg5 14. Qf3 Ng8 15. Bxf4 Qf6
16. Nc3 Bc5 17. Nd5 Qxb2 18. Bd6 Bxg1 19. e5 Qxa1+ 20. Ke2 Na6 21. Nxg7+ Kd8
22. Qf6+ Nxf6 23. Be7# 1-0`;

            const temp = new Chess();
            if (temp.load_pgn(pgn)) {
                game = temp;
                isImmortalGame = true;
                history = [];
                const rebuild = new Chess();
                history.push(rebuild.fen());
                game.history().forEach(m => {
                    rebuild.move(m);
                    history.push(rebuild.fen());
                });
                currentIndex = history.length - 1;
                playerSide = document.getElementById('side-select').value;
                difficulty = parseInt(document.getElementById('difficulty-select').value);
                initBoard(playerSide === 'w' ? 'white' : 'black');
                updateNavButtons();
                updateStatus();
            }
        });

        // Resta de funcions (AI, desar, carregar)
        const pieceValues = { p: 100, n: 320, b: 330, r: 500, q: 900, k: 20000 };

        function evaluateBoard(g) {
            if (g.in_checkmate()) return g.turn() === 'w' ? -Infinity : Infinity;
            if (g.in_draw()) return 0;
            let total = 0;
            const b = g.board();
            for (let i = 0; i < 8; i++) for (let j = 0; j < 8; j++) {
                const p = b[i][j];
                if (p) {
                    let v = pieceValues[p.type];
                    if (p.color === 'b') v = -v;
                    total += v;
                }
            }
            return total;
        }

        function minimax(g, depth, alpha, beta, max) {
            if (depth === 0 || g.game_over()) return evaluateBoard(g);
            const moves = g.moves();
            if (max) {
                let best = -Infinity;
                for (const m of moves) {
                    g.move(m);
                    best = Math.max(best, minimax(g, depth - 1, alpha, beta, false));
                    g.undo();
                    alpha = Math.max(alpha, best);
                    if (beta <= alpha) break;
                }
                return best;
            } else {
                let best = Infinity;
                for (const m of moves) {
                    g.move(m);
                    best = Math.min(best, minimax(g, depth - 1, alpha, beta, true));
                    g.undo();
                    beta = Math.min(beta, best);
                    if (beta <= alpha) break;
                }
                return best;
            }
        }

        function findBestMove(g) {
            const moves = g.moves();
            if (!moves.length) return null;
            let bestMove = moves[0];
            let bestValue = g.turn() === 'w' ? -Infinity : Infinity;
            for (const m of moves) {
                g.move(m);
                const val = minimax(g, difficulty - 1, -Infinity, Infinity, g.turn() === 'w');
                g.undo();
                if ((g.turn() === 'w' && val > bestValue) || (g.turn() === 'b' && val < bestValue)) {
                    bestValue = val;
                    bestMove = m;
                }
            }
            return bestMove;
        }

        document.getElementById('save-pgn-btn').addEventListener('click', () => {
            const temp = new Chess();
            temp.load_pgn(game.pgn());
            const pgn = temp.pgn({ max_width: 80, newline_char: '\n' });
            const blob = new Blob([pgn || ''], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `escacs_${new Date().toISOString().slice(0,10)}.pgn`;
            a.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById('load-pgn-file').addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                const temp = new Chess();
                if (temp.load_pgn(ev.target.result)) {
                    game = temp;
                    isImmortalGame = false;
                    history = [];
                    const rebuild = new Chess();
                    history.push(rebuild.fen());
                    game.history().forEach(m => {
                        rebuild.move(m);
                        history.push(rebuild.fen());
                    });
                    currentIndex = history.length - 1;
                    playerSide = document.getElementById('side-select').value;
                    difficulty = parseInt(document.getElementById('difficulty-select').value);
                    initBoard(playerSide === 'w' ? 'white' : 'black');
                    updateNavButtons();
                    updateStatus();
                    if (game.turn() !== playerSide && !game.game_over()) makeAIMove();
                } else alert('Error carregant PGN');
            };
            reader.readAsText(file);
        });

        document.getElementById('new-game-btn').addEventListener('click', startNewGame);

        // Navegaci√≥
        document.getElementById('start-btn').addEventListener('click', () => goToIndex(0));
        document.getElementById('prev-btn').addEventListener('click', () => goToIndex(currentIndex - 1));
        document.getElementById('next-btn').addEventListener('click', () => {
            if (currentIndex < history.length - 1) {
                goToIndex(currentIndex + 1);
            } else if (!game.game_over() && game.turn() !== playerSide) {
                makeAIMove();
            }
        });
        document.getElementById('end-btn').addEventListener('click', () => goToIndex(history.length - 1));

        function resizeBoard() { if (board) board.resize(); }
        window.addEventListener('resize', resizeBoard);
        window.addEventListener('orientationchange', resizeBoard);
    </script>
</body>
</html>
