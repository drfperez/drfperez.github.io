<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Play Chess</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: manipulation;
        }

        body.thinking {
            cursor: progress;
        }

        #board-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #board {
            width: 95vmin;
            height: 95vmin;
            max-width: 100vw;
            max-height: 70vh;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
        }

        /* Top bar - NEW */
        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(20, 20, 20, 0.9);
            padding: 8px 0;
            box-sizing: border-box;
            text-align: center;
            color: white;
            z-index: 5;
            border-bottom: 2px solid #2ecc71;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            min-height: 60px;
        }

        .top-left-controls {
            display: flex;
            gap: 6px;
            padding-left: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .top-center {
            flex-grow: 1;
            text-align: center;
        }

        .top-right-controls {
            display: flex;
            gap: 6px;
            padding-right: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .title {
            color: #2ecc71;
            font-size: 22px;
            font-weight: bold;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
            letter-spacing: 1px;
            margin: 0;
        }

        /* Bottom panel - MODIFIED */
        .panel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(20, 20, 20, 0.95);
            padding: 8px 0;
            box-sizing: border-box;
            text-align: center;
            color: white;
            z-index: 10;
            border-top: 2px solid #2ecc71;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
            padding: 0 4px;
        }

        .nav-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
            padding: 0 4px;
        }

        /* Button styles */
        select, button, .nav-btn, .icon-btn {
            padding: 0;
            width: 44px;
            height: 44px;
            font-size: 20px;
            border-radius: 6px;
            border: none;
            background: #2ecc71;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        select {
            background: #f8f8f8;
            font-size: 18px;
            padding: 0 8px;
            width: 54px;
        }

        .nav-btn {
            background: #34495e;
            color: white;
        }

        .nav-btn:disabled {
            background: #555;
            opacity: 0.5;
            cursor: not-allowed;
        }

        .icon-btn {
            background: #3498db;
            color: white;
            font-size: 22px;
        }

        .info-btn {
            background: #9b59b6;
            color: white;
        }

        .file-label {
            width: 44px;
            height: 44px;
            background: #9b59b6;
            color: white;
            font-size: 22px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .file-label input { display: none; }

        button:hover:not(:disabled), .nav-btn:hover:not(:disabled), select:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }

        button:active:not(:disabled), .nav-btn:active:not(:disabled), .icon-btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .status {
            font-weight: bold;
            margin: 0;
            color: #2ecc71;
            text-shadow: 0 0 6px rgba(46, 204, 113, 0.5);
            font-size: 16px;
            min-height: 24px;
            padding: 0 12px;
            text-align: center;
        }

        /* Engine status - POSITION FIXED */
        .engine-status {
            position: fixed;
            top: 70px;
            right: 10px;
            background: rgba(52, 152, 219, 0.9);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            z-index: 2;
        }

        /* Promotion modal */
        #promotion-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .promotion-choice {
            display: flex;
            gap: 15px;
            background: rgba(40, 40, 40, 0.9);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #2ecc71;
        }

        .promotion-piece {
            width: 60px;
            height: 60px;
            background: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .promotion-piece:hover {
            transform: scale(1.1);
            background: #f0f0f0;
        }

        /* Info Modal */
        #info-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            z-index: 200;
            padding: 20px;
        }

        .modal-content {
            background: rgba(30, 30, 30, 0.95);
            border-radius: 12px;
            border: 2px solid #2ecc71;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 25px;
            color: white;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 1px solid #2ecc71;
            padding-bottom: 15px;
        }

        .modal-title {
            font-size: 24px;
            color: #2ecc71;
            font-weight: bold;
        }

        .close-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .language-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(40, 40, 40, 0.7);
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .language-title {
            color: #3498db;
            font-size: 20px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .language-section h3 {
            color: #2ecc71;
            margin: 15px 0 10px;
            font-size: 18px;
        }

        .language-section ul {
            padding-left: 20px;
            margin: 10px 0;
        }

        .language-section li {
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .language-section p {
            line-height: 1.5;
            margin: 10px 0;
        }

        .credits {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid #444;
            text-align: center;
            color: #aaa;
            font-size: 14px;
        }

        /* Media queries for mobile */
        @media (max-width: 768px) {
            #board {
                max-height: 65vh;
                margin-top: 10px;
            }

            .top-bar {
                padding: 6px 0;
                min-height: 50px;
            }

            .top-left-controls, .top-right-controls {
                padding: 0 5px;
                gap: 4px;
            }

            .title {
                font-size: 18px;
            }

            select, button, .nav-btn, .icon-btn, .file-label {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }

            select {
                width: 48px;
                font-size: 16px;
            }

            .engine-status {
                top: 55px;
                font-size: 11px;
                padding: 3px 8px;
            }

            .control-row, .nav-row {
                gap: 4px;
            }

            .status {
                font-size: 14px;
                padding: 0 8px;
            }

            .modal-content {
                padding: 15px;
                max-height: 85vh;
            }

            .modal-title {
                font-size: 20px;
            }

            .language-title {
                font-size: 18px;
            }
        }

        @media (max-width: 480px) {
            #board {
                max-height: 60vh;
            }

            .top-bar {
                flex-direction: column;
                gap: 5px;
                padding: 5px 0;
                min-height: 70px;
            }

            .top-left-controls, .top-right-controls {
                width: 100%;
                justify-content: center;
            }

            .top-center {
                order: -1;
                width: 100%;
            }

            .title {
                font-size: 16px;
            }

            select, button, .nav-btn, .icon-btn, .file-label {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }

            select {
                width: 44px;
                font-size: 14px;
            }

            .engine-status {
                top: 65px;
                font-size: 10px;
                padding: 2px 6px;
            }
        }

        @media (max-height: 700px) {
            #board {
                max-height: 55vh;
            }

            .engine-status {
                top: 55px;
            }
        }
        
        
        /* ===== DESKTOP LAYOUT ===== */
@media (min-width: 1024px) {

    body {
        overflow: hidden;
    }

    #board-container {
        flex-direction: row;
        align-items: center;
        justify-content: center;
        padding-top: 70px;   /* top-bar */
        padding-bottom: 120px; /* bottom panel */
        gap: 30px;
    }

    #board {
        width: min(70vh, 70vw);
        height: min(70vh, 70vw);
        max-width: 720px;
        max-height: 720px;
    }

    /* Bottom panel passa a lateral */
    .panel {
        position: relative;
        width: 320px;
        max-width: 320px;
        height: auto;
        border-top: none;
        border-left: 2px solid #2ecc71;
        padding: 12px;
    }

    .control-row,
    .nav-row {
        justify-content: center;
    }

    .status {
        font-size: 15px;
    }
}
@media (min-width: 1400px) {
    #board {
        max-width: 820px;
        max-height: 820px;
    }
}

    </style>
</head>
<body>

    <div id="board-container">
        <!-- Top Bar - NEW LAYOUT -->
        <div class="top-bar">
            <div class="top-left-controls">
                <button class="icon-btn info-btn" id="info-btn" title="Game Information">‚ÑπÔ∏è</button>
                <select id="side-select" title="Side">
                    <option value="w">‚ôî</option>
                    <option value="b">‚ôö</option>
                </select>
                <select id="difficulty-select" title="Difficulty">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3" selected>3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                </select>
                <select id="variant-select" title="Variant: S=Standard, F=Fischer Random">
                    <option value="standard" selected>S</option>
                    <option value="960">F</option>
                </select>
            </div>
            
            <div class="top-center">
                <div class="title">‚ôî PLAY CHESS ‚ôö</div>
            </div>
            
            <div class="top-right-controls">
                <button class="icon-btn" id="flip-btn" title="Flip Board">‚Üª</button>
                <button class="icon-btn" id="undo-btn" title="Undo Move">‚Ü∂</button>
                <button class="icon-btn" id="new-game-btn" title="New Game">‚Ü∫</button>
            </div>
        </div>

        <div id="board"></div>
        <div class="engine-status" id="engine-status">Stockfish</div>
        
        <!-- Bottom Panel - REORGANIZED -->
        <div class="panel">
            <!-- First row: File operations and special game -->
            <div class="control-row">
                <button class="icon-btn" id="save-pgn-btn" title="Save Game">üíæ</button>
                <label class="file-label" title="Load Game">üìÇ
                    <input type="file" id="load-pgn-file" accept=".pgn,text/plain">
                </label>
                <button class="icon-btn" id="load-example-btn" title="Immortal Game">‚òÖ</button>
            </div>

            <!-- Second row: Navigation controls -->
            <div class="nav-row">
                <button class="nav-btn" id="start-btn" title="Go to Start">‚èÆ</button>
                <button class="nav-btn" id="prev-btn" title="Previous Move">‚óÄ</button>
                <span id="move-number" style="min-width:60px; color:#2ecc71; font-weight:bold; font-size:18px;">0</span>
                <button class="nav-btn" id="next-btn" title="Next Move">‚ñ∂</button>
                <button class="nav-btn" id="end-btn" title="Go to End">‚è≠</button>
            </div>

            <!-- Status display -->
            <div id="status" class="status">Press ‚Ü∫ to start a new game</div>
        </div>
    </div>

    <!-- Promotion modal -->
    <div id="promotion-modal">
        <div class="promotion-choice">
            <div class="promotion-piece" data-piece="q">‚ôï</div>
            <div class="promotion-piece" data-piece="r">‚ôñ</div>
            <div class="promotion-piece" data-piece="b">‚ôó</div>
            <div class="promotion-piece" data-piece="n">‚ôò</div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="info-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚ÑπÔ∏è Game Information</div>
                <button class="close-btn" id="close-modal">√ó</button>
            </div>
            
            <div class="language-section">
                <div class="language-title">Game Features</div>
                
                <h3>üéÆ How to play:</h3>
                <ul>
                    <li><strong>Choose your side:</strong> ‚ôî (White) or ‚ôö (Black)</li>
                    <li><strong>Adjust difficulty:</strong> From level 1 (easy) to 6 (Stockfish expert)</li>
                    <li><strong>Make moves:</strong> Drag and drop pieces</li>
                    <li><strong>Pawn promotion:</strong> When a pawn reaches the end, choose promotion piece</li>
                </ul>
                
                <h3>üîÑ Top controls:</h3>
                <ul>
                    <li><strong>‚ÑπÔ∏è</strong> Game information</li>
                    <li><strong>‚Üª</strong> Flip board</li>
                    <li><strong>‚Ü∂</strong> Undo move</li>
                    <li><strong>‚Ü∫</strong> New game</li>
                </ul>
                
                <h3>üíæ Bottom controls:</h3>
                <ul>
                    <li><strong>üíæ</strong> Save game (PGN)</li>
                    <li><strong>üìÇ</strong> Load saved game</li>
                    <li><strong>‚òÖ</strong> Immortal Game with comments</li>
                    <li><strong>‚èÆ ‚óÄ ‚ñ∂ ‚è≠</strong> Navigate through moves</li>
                </ul>
                
                <h3>üèÜ Chess Variants:</h3>
                <ul>
                    <li><strong>Standard (S):</strong> Traditional chess with standard starting position</li>
                    <li><strong>Fischer Random (F):</strong> Also known as Chess960. The back rank pieces are randomly arranged following specific rules:</li>
                    <ul>
                        <li>Two bishops must be on opposite-colored squares</li>
                        <li>The king must be between the two rooks</li>
                        <li>There are 960 possible starting positions</li>
                        <li>Castling rules adapt to the random setup</li>
                        <li>Eliminates opening theory memorization</li>
                    </ul>
                </ul>
                
                <h3>ü§ñ Chess Engine Details</h3>
<p><strong>Levels 1-5:</strong> Custom-built engine using an optimized Minimax algorithm with Alpha-Beta pruning. Search depth and decision quality increase with each level:</p>
<ul>
    <li><strong>Level 1:</strong> Very easy - Searches 1 move ahead, suitable for beginners</li>
    <li><strong>Level 2:</strong> Easy - Searches 2 moves ahead, basic tactics</li>
    <li><strong>Level 3:</strong> Medium - Searches 3 moves ahead, decent positional play</li>
    <li><strong>Level 4:</strong> Hard - Searches 4 moves ahead, good tactical awareness</li>
    <li><strong>Level 5:</strong> Very Hard - Searches 5 moves ahead, strong chess understanding</li>
</ul>
<p><strong>Level 6:</strong> Full Stockfish engine - The world's strongest chess engine. Uses advanced algorithms, neural networks, and searches 20+ moves ahead. Professional-level play that can challenge grandmasters.</p>
<p><em>Note: Level 6 requires an internet connection to load the Stockfish engine from CDN.</em></p>
            </div>        
            <div class="credits">
                ‚ôüÔ∏è Chess game built with chess.js, chessboard.js and Stockfish<br>
                üì± Optimized for mobile and desktop<br>
                ‚ö° Supports both Standard Chess and Fischer Random (Chess960)
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

    <script>
        let game = null;
        let board = null;
        let playerSide = 'w';
        let difficulty = 3;
        let thinking = false;
        let history = [];
        let currentIndex = 0;
        let isImmortalGame = false;
        let pendingPromotion = null;
        let stockfish = null;

        const pieceValues = { p: 100, n: 320, b: 330, r: 500, q: 900, k: 20000 };

        const immortalComments = [
            "Initial position. White to move.",
            "1.e4 ‚Äì Standard opening move.",
            "1...e5 ‚Äì Symmetrical response.",
            "2.f4 ‚Äì King's Gambit! Anderssen offers a pawn for rapid attack.",
            "2...exf4 ‚Äì Kieseritzky accepts the gambit.",
            "3.Bc4 ‚Äì Rapid development targeting f7.",
            "3...Qh4+ ‚Äì Aggressive early check.",
            "4.Kf1 ‚Äì The king moves to avoid losing tempo.",
            "4...b5!? ‚Äì Risky counterattack offering a pawn.",
            "5.Bxb5 ‚Äì Anderssen accepts and gains material.",
            "5...Nf6 ‚Äì Develops and threatens e4.",
            "6.Nf3 ‚Äì Attacks the black queen.",
            "6...Qh6 ‚Äì Queen retreats.",
            "7.d3 ‚Äì Protects the central pawn.",
            "7...Nh5 ‚Äì Threatens the white knight.",
            "8.Nh4 ‚Äì New threat to the queen.",
            "8...Qg5",
            "9.Nf5 ‚Äì Knight to the center.",
            "9...c6 ‚Äì Attacks the white bishop.",
            "10.g4!? ‚Äì Spectacular sacrifice: offers a rook!",
            "10...Nf6",
            "11.Rg1 ‚Äì The rook enters the game and continues to be offered.",
            "11...cxb5 ‚Äì Accepts the sacrifice.",
            "12.h4 ‚Äì Direct attack on the queen.",
            "12...Qg6",
            "13.h5 ‚Äì Forces the queen to move again.",
            "13...Qg5",
            "14.Qf3 ‚Äì Develops the queen with threat.",
            "14...Ng8 ‚Äì Passive defense.",
            "15.Bxf4 ‚Äì Recovers the pawn with good development.",
            "15...Qf6",
            "16.Nc3 ‚Äì The other knight enters the game.",
            "16...Bc5",
            "17.Nd5!? ‚Äì Brilliant knight sacrifice.",
            "17...Qxb2 ‚Äì Accepted.",
            "18.Bd6! ‚Äì Sacrifice of both rooks!",
            "18...Bxg1",
            "19.e5 ‚Äì Opens central lines.",
            "19...Qxa1+",
            "20.Ke2 ‚Äì The king walks to the center without fear.",
            "20...Na6",
            "21.Nxg7+! ‚Äì Discovered check with the knight.",
            "21...Kd8",
            "22.Qf6+! ‚Äì Queen sacrifice!",
            "22...Nxf6",
            "23.Be7# ‚Äì Immortal mate! One of the most beautiful games in history."
        ];

        function generateChess960FEN() {
            const lightSquares = [1, 3, 5, 7];
            const darkSquares = [0, 2, 4, 6];
            let backRank = Array(8).fill('');
            backRank[lightSquares[Math.floor(Math.random() * 4)]] = 'B';
            backRank[darkSquares[Math.floor(Math.random() * 4)]] = 'B';
            let remaining = [];
            for (let i = 0; i < 8; i++) {
                if (backRank[i] === '') remaining.push(i);
            }
            let idx = Math.floor(Math.random() * remaining.length);
            backRank[remaining[idx]] = 'Q';
            remaining.splice(idx, 1);
            idx = Math.floor(Math.random() * remaining.length);
            backRank[remaining[idx]] = 'N';
            remaining.splice(idx, 1);
            idx = Math.floor(Math.random() * remaining.length);
            backRank[remaining[idx]] = 'N';
            remaining.splice(idx, 1);
            remaining.sort((a, b) => a - b);
            backRank[remaining[0]] = 'R';
            backRank[remaining[1]] = 'K';
            backRank[remaining[2]] = 'R';
            const whiteBack = backRank.join('');
            const blackBack = whiteBack.toLowerCase();
            const fen = `${blackBack}/pppppppp/8/8/8/8/PPPPPPPP/${whiteBack} w KQkq - 0 1`;
            return fen;
        }

        function initEngine() {
            const workerUrl = 'https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js';
            fetch(workerUrl)
                .then(response => response.text())
                .then(code => {
                    const blob = new Blob([code], { type: 'application/javascript' });
                    stockfish = new Worker(URL.createObjectURL(blob));
                    setupEngine();
                })
                .catch(err => {
                    console.error("Could not download engine: " + err);
                    document.getElementById('engine-status').innerText = "Engine: Local";
                });
        }

        function setupEngine() {
            stockfish.onmessage = function(e) {
                if (e.data.startsWith('bestmove')) {
                    const match = e.data.match(/bestmove\s([a-h][1-8][a-h][1-8][qrbn]?)/);
                    if (match) {
                        const moveStr = match[1];
                        const from = moveStr.substring(0, 2);
                        const to = moveStr.substring(2, 4);
                        const promotion = moveStr.length === 5 ? moveStr[4] : undefined;
                        const move = game.move({ from, to, promotion });
                        if (move) {
                            history.push(game.fen());
                            currentIndex = history.length - 1;
                            board.position(game.fen(), true);
                            thinking = false;
                            document.body.classList.remove('thinking');
                            updateStatus();
                            updateNavButtons();
                        }
                    }
                }
            };

            stockfish.postMessage('uci');
            stockfish.postMessage('setoption name UCI_Chess960 value true');
            stockfish.postMessage('isready');
            document.getElementById('engine-status').innerText = "Stockfish";
        }

        function getCurrentComment() {
            if (isImmortalGame && currentIndex < immortalComments.length) {
                return immortalComments[currentIndex];
            }
            return null;
        }

        function getLastMoveSAN() {
            const moves = game.history();
            if (moves.length === 0) return "";
            return moves[moves.length - 1];
        }

        function updateStatus() {
            if (thinking) {
                document.getElementById('status').innerText = "Thinking...";
                return;
            }

            const comment = getCurrentComment();
            if (comment) {
                document.getElementById('status').innerText = comment;
                return;
            }

            const lastMove = getLastMoveSAN();
            if (lastMove) {
                document.getElementById('status').innerText = lastMove;
                return;
            }

            if (game.in_checkmate()) {
                const winner = game.turn() === 'w' ? 'Black' : 'White';
                document.getElementById('status').innerText = `Checkmate! ${winner} wins`;
            } else if (game.in_draw()) {
                document.getElementById('status').innerText = "Draw";
            } else if (game.in_check()) {
                document.getElementById('status').innerText = "Check!";
            } else if (game.turn() === playerSide) {
                document.getElementById('status').innerText = "Your turn";
            } else {
                document.getElementById('status').innerText = "AI's turn";
            }
        }

        function updateMoveNumber() {
            const moveNum = Math.floor(currentIndex / 2);
            const moveDisplay = currentIndex % 2 === 1 && game.turn() === 'b' ? `${moveNum + 1}...` : `${moveNum + 1}`;
            document.getElementById('move-number').innerText = moveDisplay;
        }

        function updateNavButtons() {
            document.getElementById('start-btn').disabled = currentIndex <= 0;
            document.getElementById('prev-btn').disabled = currentIndex <= 0;
            document.getElementById('next-btn').disabled = currentIndex >= history.length - 1;
            document.getElementById('end-btn').disabled = currentIndex >= history.length - 1;
            document.getElementById('undo-btn').disabled = currentIndex === 0 || game.turn() !== playerSide || thinking;
            updateMoveNumber();
        }

        function goToIndex(index) {
            if (index < 0 || index >= history.length) return;
            currentIndex = index;
            game.load(history[currentIndex]);
            board.position(game.fen(), true);
            updateNavButtons();
            updateStatus();
        }

        function flipBoard() {
            if (board) board.flip();
        }

        function undoMove() {
            if (currentIndex < 2 || thinking) return;
            goToIndex(currentIndex - 2);
        }

        function evaluateBoard(g) {
            if (g.in_checkmate()) return g.turn() === 'w' ? -Infinity : Infinity;
            if (g.in_draw()) return 0;

            let total = 0;
            const board = g.board();
            for (let i = 0; i < 8; i++) {
                for (let j = 0; j < 8; j++) {
                    const p = board[i][j];
                    if (p) {
                        let v = pieceValues[p.type];
                        if (p.color === 'b') v = -v;
                        total += v;
                    }
                }
            }

            total += g.moves().length * (g.turn() === 'w' ? 10 : -10);

            return total;
        }

        function quiescence(g, alpha, beta, color) {
            let stand_pat = evaluateBoard(g);
            if (color === 'b') stand_pat = -stand_pat;

            if (stand_pat >= beta) return beta;
            if (alpha < stand_pat) alpha = stand_pat;

            const captures = g.moves({ verbose: true }).filter(m => m.captured);
            for (const move of captures) {
                g.move(move);
                const score = -quiescence(g, -beta, -alpha, color === 'w' ? 'b' : 'w');
                g.undo();
                if (score >= beta) return beta;
                if (score > alpha) alpha = score;
            }
            return alpha;
        }

        function minimax(g, depth, alpha, beta, maximizing) {
            if (depth === 0 || g.game_over()) {
                let score = evaluateBoard(g);
                if (!g.game_over() && depth === 0) {
                    score += quiescence(g, -Infinity, Infinity, g.turn()) * (g.turn() === 'w' ? 1 : -1);
                }
                return score;
            }

            const moves = g.moves({ verbose: true });
            moves.sort((a, b) => {
                const aVal = a.captured ? pieceValues[a.captured] : 0;
                const bVal = b.captured ? pieceValues[b.captured] : 0;
                return bVal - aVal;
            });

            if (maximizing) {
                let maxEval = -Infinity;
                for (const move of moves) {
                    g.move(move);
                    const eval = minimax(g, depth - 1, alpha, beta, false);
                    g.undo();
                    maxEval = Math.max(maxEval, eval);
                    alpha = Math.max(alpha, maxEval);
                    if (beta <= alpha) break;
                }
                return maxEval;
            } else {
                let minEval = Infinity;
                for (const move of moves) {
                    g.move(move);
                    const eval = minimax(g, depth - 1, alpha, beta, true);
                    g.undo();
                    minEval = Math.min(minEval, eval);
                    beta = Math.min(beta, minEval);
                    if (beta <= alpha) break;
                }
                return minEval;
            }
        }

        function findBestMove(g) {
            const moves = g.moves({ verbose: true });
            if (moves.length === 0) return null;

            moves.sort((a, b) => {
                const aVal = a.captured ? pieceValues[a.captured] : 0;
                const bVal = b.captured ? pieceValues[b.captured] : 0;
                return bVal - aVal;
            });

            let bestMove = moves[0];
            let bestValue = g.turn() === 'w' ? -Infinity : Infinity;

            for (const move of moves) {
                g.move(move);
                const value = minimax(g, difficulty - 1, -Infinity, Infinity, g.turn() === 'w');
                g.undo();

                if ((g.turn() === 'w' && value > bestValue) || (g.turn() === 'b' && value < bestValue)) {
                    bestValue = value;
                    bestMove = move;
                }
            }
            return bestMove.san;
        }

        function makeAIMove() {
            if (thinking || game.game_over() || game.turn() === playerSide) return;

            thinking = true;
            document.body.classList.add('thinking');
            updateStatus();

            if (difficulty < 6) {
                setTimeout(() => {
                    const move = findBestMove(game);
                    if (move) {
                        game.move(move);
                        history.push(game.fen());
                        currentIndex = history.length - 1;
                        board.position(game.fen(), true);
                    }
                    thinking = false;
                    document.body.classList.remove('thinking');
                    updateStatus();
                    updateNavButtons();
                }, 200);
            } else {
                if (stockfish) {
                    stockfish.postMessage('position fen ' + game.fen());
                    stockfish.postMessage('go depth 12');
                } else {
                    thinking = false;
                    document.body.classList.remove('thinking');
                    document.getElementById('status').innerText = "Error: Stockfish engine not initialized.";
                }
            }
        }

        function onDrop(source, target) {
            if (thinking || game.turn() !== playerSide) return 'snapback';

            const piece = game.get(source);
            const isPawn = piece && piece.type === 'p';
            const isPromotionRank = (piece.color === 'w' && target[1] === '8') || (piece.color === 'b' && target[1] === '1');

            if (isPawn && isPromotionRank) {
                pendingPromotion = { source, target };
                document.getElementById('promotion-modal').style.display = 'flex';
                return 'snapback';
            }

            const move = game.move({
                from: source,
                to: target,
                promotion: 'q'
            });

            if (move === null) return 'snapback';

            history.push(game.fen());
            currentIndex = history.length - 1;
            board.position(game.fen(), true);
            updateNavButtons();
            updateStatus();
            makeAIMove();
        }

        function onSnapEnd() {
            board.position(game.fen(), true);
        }

        function initBoard(orientation) {
            const config = {
                draggable: true,
                position: game.fen(),
                orientation: orientation,
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
                onDrop: onDrop,
                onSnapEnd: onSnapEnd
            };
            if (board) board.destroy();
            board = ChessBoard('board', config);
        }

        function startNewGame() {
            const variant = document.getElementById('variant-select').value;
            let fen;
            if (variant === '960') {
                fen = generateChess960FEN();
                document.querySelector('.title').innerText = '‚ôî PLAY 960 ‚ôö';
            } else {
                fen = undefined;
                document.querySelector('.title').innerText = '‚ôî PLAY CHESS ‚ôö';
            }
            game = new Chess(fen);
            history = [game.fen()];
            currentIndex = 0;
            isImmortalGame = false;
            playerSide = document.getElementById('side-select').value;
            difficulty = parseInt(document.getElementById('difficulty-select').value);

            initBoard(playerSide === 'w' ? 'white' : 'black');
            updateNavButtons();
            updateStatus();

            if (playerSide !== 'w') makeAIMove();
        }

        // Event listeners
        document.getElementById('flip-btn').addEventListener('click', flipBoard);
        document.getElementById('undo-btn').addEventListener('click', undoMove);
        document.getElementById('new-game-btn').addEventListener('click', startNewGame);

        // Info modal functionality
        document.getElementById('info-btn').addEventListener('click', function() {
            document.getElementById('info-modal').style.display = 'flex';
        });

        document.getElementById('close-modal').addEventListener('click', function() {
            document.getElementById('info-modal').style.display = 'none';
        });

        // Close modal when clicking outside
        document.getElementById('info-modal').addEventListener('click', function(e) {
            if (e.target.id === 'info-modal') {
                document.getElementById('info-modal').style.display = 'none';
            }
        });

        document.getElementById('load-example-btn').addEventListener('click', () => {
            const pgn = `[Event "The Immortal Game"]
[Site "London 1851"]
[White "Adolf Anderssen"]
[Black "Lionel Kieseritzky"]
[Result "1-0"]

1. e4 e5 2. f4 exf4 3. Bc4 Qh4+ 4. Kf1 b5 5. Bxb5 Nf6 6. Nf3 Qh6 7. d3 Nh5 8. Nh4 Qg5
9. Nf5 c6 10. g4 Nf6 11. Rg1 cxb5 12. h4 Qg6 13. h5 Qg5 14. Qf3 Ng8 15. Bxf4 Qf6
16. Nc3 Bc5 17. Nd5 Qxb2 18. Bd6 Bxg1 19. e5 Qxa1+ 20. Ke2 Na6 21. Nxg7+ Kd8
22. Qf6+ Nxf6 23. Be7# 1-0`;

            const temp = new Chess();
            if (temp.load_pgn(pgn)) {
                game = temp;
                isImmortalGame = true;
                history = [];
                const rebuild = new Chess();
                history.push(rebuild.fen());
                game.history().forEach(m => {
                    rebuild.move(m);
                    history.push(rebuild.fen());
                });
                currentIndex = history.length - 1;
                playerSide = document.getElementById('side-select').value;
                initBoard(playerSide === 'w' ? 'white' : 'black');
                updateNavButtons();
                updateStatus();
            }
        });

        document.getElementById('save-pgn-btn').addEventListener('click', () => {
            const temp = new Chess();
            temp.load_pgn(game.pgn());
            const pgn = temp.pgn({ max_width: 80, newline_char: '\n' });
            const blob = new Blob([pgn || ''], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chess_${new Date().toISOString().slice(0,10)}.pgn`;
            a.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById('load-pgn-file').addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                const temp = new Chess();
                if (temp.load_pgn(ev.target.result)) {
                    game = temp;
                    isImmortalGame = false;
                    history = [];
                    const rebuild = new Chess();
                    history.push(rebuild.fen());
                    game.history().forEach(m => {
                        rebuild.move(m);
                        history.push(rebuild.fen());
                    });
                    currentIndex = history.length - 1;
                    playerSide = document.getElementById('side-select').value;
                    initBoard(playerSide === 'w' ? 'white' : 'black');
                    updateNavButtons();
                    updateStatus();
                    if (game.turn() !== playerSide && !game.game_over()) makeAIMove();
                } else {
                    alert('Error loading PGN file');
                }
            };
            reader.readAsText(file);
        });

        // Navigation
        document.getElementById('start-btn').addEventListener('click', () => goToIndex(0));
        document.getElementById('prev-btn').addEventListener('click', () => goToIndex(currentIndex - 1));
        document.getElementById('next-btn').addEventListener('click', () => {
            if (currentIndex < history.length - 1) {
                goToIndex(currentIndex + 1);
            } else if (!game.game_over() && game.turn() !== playerSide) {
                makeAIMove();
            }
        });
        document.getElementById('end-btn').addEventListener('click', () => goToIndex(history.length - 1));

        // Promotion choice
        document.querySelectorAll('.promotion-piece').forEach(el => {
            el.addEventListener('click', () => {
                if (!pendingPromotion) return;
                const { source, target } = pendingPromotion;
                const promotion = el.dataset.piece;

                const move = game.move({
                    from: source,
                    to: target,
                    promotion: promotion
                });

                if (move) {
                    history.push(game.fen());
                    currentIndex = history.length - 1;
                    board.position(game.fen(), true);
                    updateNavButtons();
                    updateStatus();
                    makeAIMove();
                }

                document.getElementById('promotion-modal').style.display = 'none';
                pendingPromotion = null;
            });
        });

        // Resize handling
        function resizeBoard() { if (board) board.resize(); }
        window.addEventListener('resize', resizeBoard);
        window.addEventListener('orientationchange', resizeBoard);

        // Initialize engine
        initEngine();

        // Initial start
        startNewGame();
    </script>
</body>
</html>
