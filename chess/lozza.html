
<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Play Chess</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: manipulation;
        }

        body.thinking {
            cursor: progress;
        }

        #board-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #board {
            width: 95vmin;
            height: 95vmin;
            max-width: 100vw;
            max-height: 85vh;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
        }

        .panel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(20, 20, 20, 0.95);
            padding: 8px 0;
            box-sizing: border-box;
            text-align: center;
            color: white;
            z-index: 10;
            border-top: 2px solid #2ecc71;
        }

        .compact-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
            padding: 0 4px;
        }

        select, button, .nav-btn, .icon-btn {
            padding: 0;
            width: 44px;
            height: 44px;
            font-size: 20px;
            border-radius: 6px;
            border: none;
            background: #2ecc71;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        select {
            background: #f8f8f8;
            font-size: 18px;
            padding: 0 8px;
            width: 54px;
        }

        .nav-btn {
            background: #34495e;
            color: white;
        }

        .nav-btn:disabled {
            background: #555;
            opacity: 0.5;
            cursor: not-allowed;
        }

        .icon-btn {
            background: #3498db;
            color: white;
            font-size: 22px;
        }

        .file-label {
            width: 44px;
            height: 44px;
            background: #9b59b6;
            color: white;
            font-size: 22px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .file-label input { display: none; }

        button:hover:not(:disabled), .nav-btn:hover:not(:disabled), select:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }

        button:active:not(:disabled), .nav-btn:active:not(:disabled), .icon-btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .status {
            font-weight: bold;
            margin: 8px 0 6px;
            color: #2ecc71;
            text-shadow: 0 0 6px rgba(46, 204, 113, 0.5);
            font-size: 16px;
            min-height: 24px;
            padding: 0 12px;
            text-align: center;
        }

        /* Promotion modal */
        #promotion-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .promotion-choice {
            display: flex;
            gap: 15px;
            background: rgba(40, 40, 40, 0.9);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #2ecc71;
        }

        .promotion-piece {
            width: 60px;
            height: 60px;
            background: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .promotion-piece:hover {
            transform: scale(1.1);
            background: #f0f0f0;
        }

        /* Logo/title */
        .title {
            position: absolute;
            top: 10px;
            left: 0;
            width: 100%;
            text-align: center;
            color: #2ecc71;
            font-size: 22px;
            font-weight: bold;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
            letter-spacing: 1px;
        }

        /* Engine status */
        .engine-status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(52, 152, 219, 0.8);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        /* Media queries for mobile */
        @media (max-width: 600px) {
            #board {
                max-height: 75vh;
            }
            
            .compact-row {
                gap: 4px;
            }
            
            select, button, .nav-btn, .icon-btn, .file-label {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            select {
                width: 48px;
            }
            
            .title {
                font-size: 18px;
                top: 5px;
            }
        }
    </style>
</head>
<body>

    <div id="board-container">
        <div class="title">‚ôî PLAY CHESS ‚ôö</div>
        <div id="board"></div>
        <div class="engine-status" id="engine-status">Motor: Stockfish</div>
        
        <div class="panel">
            <div class="compact-row">
                <select id="side-select" title="Costat">
                    <option value="w">Blanques ‚ôî</option>
                    <option value="b">Negres ‚ôö</option>
                </select>
                <select id="difficulty-select" title="Dificultat">
                    <option value="1">F√†cil 1</option>
                    <option value="2">F√†cil 2</option>
                    <option value="3" selected>Normal 3</option>
                    <option value="4">Normal 4</option>
                    <option value="5">Dif√≠cil 5</option>
                    <option value="6">Expert 6</option>
                </select>
                <button class="icon-btn" id="flip-btn" title="Girar tauler">‚Üª</button>
                <button class="icon-btn" id="undo-btn" title="Desfer moviment">‚Ü∂</button>
                <button class="icon-btn" id="new-game-btn" title="Nova partida">‚Ü∫</button>
                <button class="icon-btn" id="save-pgn-btn" title="Desar partida">üíæ</button>
                <label class="file-label" title="Carregar partida">üìÇ
                    <input type="file" id="load-pgn-file" accept=".pgn,text/plain">
                </label>
                <button class="icon-btn" id="load-example-btn" title="Partida Immortal comentada">‚òÖ</button>
            </div>

            <div class="compact-row navigation">
                <button class="nav-btn" id="start-btn" title="Anar a l'inici">‚èÆ</button>
                <button class="nav-btn" id="prev-btn" title="Moviment anterior">‚óÄ</button>
                <span id="move-number" style="min-width:60px; color:#2ecc71; font-weight:bold; font-size:18px;">0</span>
                <button class="nav-btn" id="next-btn" title="Seg√ºent moviment">‚ñ∂</button>
                <button class="nav-btn" id="end-btn" title="Anar al final">‚è≠</button>
            </div>

            <div id="status" class="status">Prem ‚Ü∫ per comen√ßar una nova partida</div>
        </div>
    </div>

    <!-- Promotion modal -->
    <div id="promotion-modal">
        <div class="promotion-choice">
            <div class="promotion-piece" data-piece="q">‚ôï</div>
            <div class="promotion-piece" data-piece="r">‚ôñ</div>
            <div class="promotion-piece" data-piece="b">‚ôó</div>
            <div class="promotion-piece" data-piece="n">‚ôò</div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

    <script>
        let game = null;
        let board = null;
        let playerSide = 'w';
        let difficulty = 3;
        let thinking = false;
        let history = [];
        let currentIndex = 0;
        let isImmortalGame = false;
        let pendingPromotion = null;
        let stockfish = null;

        const pieceValues = { p: 100, n: 320, b: 330, r: 500, q: 900, k: 20000 };

        const immortalComments = [
            "Posici√≥ inicial. Les blanques comencen.",
            "1.e4 ‚Äì Obertura est√†ndard.",
            "1...e5 ‚Äì Resposta sim√®trica.",
            "2.f4 ‚Äì Gambit de rei! Anderssen ofereix un pe√≥ per atac r√†pid.",
            "2...exf4 ‚Äì Kieseritzky accepta el gambit.",
            "3.Bc4 ‚Äì Desenvolupament r√†pid apuntant a f7.",
            "3...Qh4+ ‚Äì Xeic agressiu molt aviat.",
            "4.Kf1 ‚Äì El rei es mou per no perdre temps.",
            "4...b5!? ‚Äì Contraatac arriscat oferint un pe√≥.",
            "5.Bxb5 ‚Äì Anderssen accepta i guanya material.",
            "5...Nf6 ‚Äì Desenvolupa i amena√ßa e4.",
            "6.Nf3 ‚Äì Ataca la dama negra.",
            "6...Qh6 ‚Äì La dama es retira.",
            "7.d3 ‚Äì Protegeix el pe√≥ central.",
            "7...Nh5 ‚Äì Amena√ßa el cavall blanc.",
            "8.Nh4 ‚Äì Nova amena√ßa a la dama.",
            "8...Qg5",
            "9.Nf5 ‚Äì Cavall al centre.",
            "9...c6 ‚Äì Ataca l'alfil blanc.",
            "10.g4!? ‚Äì Sacrifici espectacular: ofereix una torre!",
            "10...Nf6",
            "11.Rg1 ‚Äì La torre es posa en joc i es continua oferint.",
            "11...cxb5 ‚Äì Acceptat el sacrifici.",
            "12.h4 ‚Äì Atac directe a la dama.",
            "12...Qg6",
            "13.h5 ‚Äì For√ßa la dama a moure's de nou.",
            "13...Qg5",
            "14.Qf3 ‚Äì Desenvolupa la dama amb amena√ßa.",
            "14...Ng8 ‚Äì Defensa passiva.",
            "15.Bxf4 ‚Äì Recupera el pe√≥ amb bon desenvolupament.",
            "15...Qf6",
            "16.Nc3 ‚Äì L'altre cavall entra en joc.",
            "16...Bc5",
            "17.Nd5!? ‚Äì Sacrifici de cavall brillant.",
            "17...Qxb2 ‚Äì Acceptat.",
            "18.Bd6! ‚Äì Sacrifici de les dues torres!",
            "18...Bxg1",
            "19.e5 ‚Äì Obra l√≠nies centrals.",
            "19...Qxa1+",
            "20.Ke2 ‚Äì El rei camina cap al centre sense por.",
            "20...Na6",
            "21.Nxg7+! ‚Äì Xeic descobert amb el cavall.",
            "21...Kd8",
            "22.Qf6+! ‚Äì Sacrifici de dama!",
            "22...Nxf6",
            "23.Be7# ‚Äì Mat immortal! Una de les partides m√©s belles de la hist√≤ria."
        ];

        function initEngine() {
            const workerUrl = 'https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js';
            fetch(workerUrl)
                .then(response => response.text())
                .then(code => {
                    const blob = new Blob([code], { type: 'application/javascript' });
                    stockfish = new Worker(URL.createObjectURL(blob));
                    setupEngine();
                })
                .catch(err => {
                    console.error("No s'ha pogut descarregar el motor: " + err);
                    document.getElementById('engine-status').innerText = "Motor: Local";
                });
        }

        function setupEngine() {
            stockfish.onmessage = function(e) {
                if (e.data.startsWith('bestmove')) {
                    const match = e.data.match(/bestmove\s([a-h][1-8][a-h][1-8][qrbn]?)/);
                    if (match) {
                        const moveStr = match[1];
                        const from = moveStr.substring(0, 2);
                        const to = moveStr.substring(2, 4);
                        const promotion = moveStr.length === 5 ? moveStr[4] : undefined;
                        const move = game.move({ from, to, promotion });
                        if (move) {
                            history.push(game.fen());
                            currentIndex = history.length - 1;
                            board.position(game.fen(), true);
                            thinking = false;
                            document.body.classList.remove('thinking');
                            updateStatus();
                            updateNavButtons();
                        }
                    }
                }
            };

            stockfish.postMessage('uci');
            stockfish.postMessage('isready');
            document.getElementById('engine-status').innerText = "Motor: Stockfish (actiu)";
        }

        function getCurrentComment() {
            if (isImmortalGame && currentIndex < immortalComments.length) {
                return immortalComments[currentIndex];
            }
            return null;
        }

        function getLastMoveSAN() {
            const moves = game.history();
            if (moves.length === 0) return "";
            return moves[moves.length - 1];
        }

        function updateStatus() {
            if (thinking) {
                document.getElementById('status').innerText = "Pensant...";
                return;
            }

            const comment = getCurrentComment();
            if (comment) {
                document.getElementById('status').innerText = comment;
                return;
            }

            const lastMove = getLastMoveSAN();
            if (lastMove) {
                document.getElementById('status').innerText = lastMove;
                return;
            }

            if (game.in_checkmate()) {
                const winner = game.turn() === 'w' ? 'Negres' : 'Blanques';
                document.getElementById('status').innerText = `Mat! ${winner} guanyen`;
            } else if (game.in_draw()) {
                document.getElementById('status').innerText = "Taules";
            } else if (game.in_check()) {
                document.getElementById('status').innerText = "Escac!";
            } else if (game.turn() === playerSide) {
                document.getElementById('status').innerText = "El teu torn";
            } else {
                document.getElementById('status').innerText = "Torn de la IA";
            }
        }

        function updateMoveNumber() {
            document.getElementById('move-number').innerText = Math.floor(currentIndex / 2) + (currentIndex % 2 === 1 && game.turn() === 'b' ? '...' : '');
        }

        function updateNavButtons() {
            document.getElementById('start-btn').disabled = currentIndex <= 0;
            document.getElementById('prev-btn').disabled = currentIndex <= 0;
            document.getElementById('next-btn').disabled = currentIndex >= history.length - 1;
            document.getElementById('end-btn').disabled = currentIndex >= history.length - 1;
            document.getElementById('undo-btn').disabled = currentIndex === 0 || game.turn() !== playerSide || thinking;
            updateMoveNumber();
        }

        function goToIndex(index) {
            if (index < 0 || index >= history.length) return;
            currentIndex = index;
            game.load(history[currentIndex]);
            board.position(game.fen(), true);
            updateNavButtons();
            updateStatus();
        }

        function flipBoard() {
            if (board) board.flip();
        }

        function undoMove() {
            if (currentIndex < 2 || thinking) return;
            goToIndex(currentIndex - 2);
        }

        function evaluateBoard(g) {
            if (g.in_checkmate()) return g.turn() === 'w' ? -Infinity : Infinity;
            if (g.in_draw()) return 0;

            let total = 0;
            const board = g.board();
            for (let i = 0; i < 8; i++) {
                for (let j = 0; j < 8; j++) {
                    const p = board[i][j];
                    if (p) {
                        let v = pieceValues[p.type];
                        if (p.color === 'b') v = -v;
                        total += v;
                    }
                }
            }

            total += g.moves().length * (g.turn() === 'w' ? 10 : -10);

            return total;
        }

        function quiescence(g, alpha, beta, color) {
            let stand_pat = evaluateBoard(g);
            if (color === 'b') stand_pat = -stand_pat;

            if (stand_pat >= beta) return beta;
            if (alpha < stand_pat) alpha = stand_pat;

            const captures = g.moves({ verbose: true }).filter(m => m.captured);
            for (const move of captures) {
                g.move(move);
                const score = -quiescence(g, -beta, -alpha, color === 'w' ? 'b' : 'w');
                g.undo();
                if (score >= beta) return beta;
                if (score > alpha) alpha = score;
            }
            return alpha;
        }

        function minimax(g, depth, alpha, beta, maximizing) {
            if (depth === 0 || g.game_over()) {
                let score = evaluateBoard(g);
                if (!g.game_over() && depth === 0) {
                    score += quiescence(g, -Infinity, Infinity, g.turn()) * (g.turn() === 'w' ? 1 : -1);
                }
                return score;
            }

            const moves = g.moves({ verbose: true });
            moves.sort((a, b) => {
                const aVal = a.captured ? pieceValues[a.captured] : 0;
                const bVal = b.captured ? pieceValues[b.captured] : 0;
                return bVal - aVal;
            });

            if (maximizing) {
                let maxEval = -Infinity;
                for (const move of moves) {
                    g.move(move);
                    const eval = minimax(g, depth - 1, alpha, beta, false);
                    g.undo();
                    maxEval = Math.max(maxEval, eval);
                    alpha = Math.max(alpha, maxEval);
                    if (beta <= alpha) break;
                }
                return maxEval;
            } else {
                let minEval = Infinity;
                for (const move of moves) {
                    g.move(move);
                    const eval = minimax(g, depth - 1, alpha, beta, true);
                    g.undo();
                    minEval = Math.min(minEval, eval);
                    beta = Math.min(beta, minEval);
                    if (beta <= alpha) break;
                }
                return minEval;
            }
        }

        function findBestMove(g) {
            const moves = g.moves({ verbose: true });
            if (moves.length === 0) return null;

            moves.sort((a, b) => {
                const aVal = a.captured ? pieceValues[a.captured] : 0;
                const bVal = b.captured ? pieceValues[b.captured] : 0;
                return bVal - aVal;
            });

            let bestMove = moves[0];
            let bestValue = g.turn() === 'w' ? -Infinity : Infinity;

            for (const move of moves) {
                g.move(move);
                const value = minimax(g, difficulty - 1, -Infinity, Infinity, g.turn() === 'w');
                g.undo();

                if ((g.turn() === 'w' && value > bestValue) || (g.turn() === 'b' && value < bestValue)) {
                    bestValue = value;
                    bestMove = move;
                }
            }
            return bestMove.san;
        }

        function makeAIMove() {
            if (thinking || game.game_over() || game.turn() === playerSide) return;

            thinking = true;
            document.body.classList.add('thinking');
            updateStatus();

            if (difficulty < 6) {
                setTimeout(() => {
                    const move = findBestMove(game);
                    if (move) {
                        game.move(move);
                        history.push(game.fen());
                        currentIndex = history.length - 1;
                        board.position(game.fen(), true);
                    }
                    thinking = false;
                    document.body.classList.remove('thinking');
                    updateStatus();
                    updateNavButtons();
                }, 200);
            } else {
                if (stockfish) {
                    stockfish.postMessage('position fen ' + game.fen());
                    stockfish.postMessage('go depth 12');
                } else {
                    thinking = false;
                    document.body.classList.remove('thinking');
                    document.getElementById('status').innerText = "Error: Motor Stockfish no inicialitzat.";
                }
            }
        }

        function onDrop(source, target) {
            if (thinking || game.turn() !== playerSide) return 'snapback';

            const piece = game.get(source);
            const isPawn = piece && piece.type === 'p';
            const isPromotionRank = (piece.color === 'w' && target[1] === '8') || (piece.color === 'b' && target[1] === '1');

            if (isPawn && isPromotionRank) {
                pendingPromotion = { source, target };
                document.getElementById('promotion-modal').style.display = 'flex';
                return 'snapback';
            }

            const move = game.move({
                from: source,
                to: target,
                promotion: 'q'
            });

            if (move === null) return 'snapback';

            history.push(game.fen());
            currentIndex = history.length - 1;
            board.position(game.fen(), true);
            updateNavButtons();
            updateStatus();
            makeAIMove();
        }

        function onSnapEnd() {
            board.position(game.fen(), true);
        }

        function initBoard(orientation) {
            const config = {
                draggable: true,
                position: game.fen(),
                orientation: orientation,
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
                onDrop: onDrop,
                onSnapEnd: onSnapEnd
            };
            if (board) board.destroy();
            board = ChessBoard('board', config);
        }

        function startNewGame() {
            game = new Chess();
            history = [game.fen()];
            currentIndex = 0;
            isImmortalGame = false;
            playerSide = document.getElementById('side-select').value;
            difficulty = parseInt(document.getElementById('difficulty-select').value);

            initBoard(playerSide === 'w' ? 'white' : 'black');
            updateNavButtons();
            updateStatus();

            if (playerSide !== 'w') makeAIMove();
        }

        // Event listeners
        document.getElementById('flip-btn').addEventListener('click', flipBoard);
        document.getElementById('undo-btn').addEventListener('click', undoMove);
        document.getElementById('new-game-btn').addEventListener('click', startNewGame);

        document.getElementById('load-example-btn').addEventListener('click', () => {
            const pgn = `[Event "La Partida Immortal"]
[Site "London 1851"]
[White "Adolf Anderssen"]
[Black "Lionel Kieseritzky"]
[Result "1-0"]

1. e4 e5 2. f4 exf4 3. Bc4 Qh4+ 4. Kf1 b5 5. Bxb5 Nf6 6. Nf3 Qh6 7. d3 Nh5 8. Nh4 Qg5
9. Nf5 c6 10. g4 Nf6 11. Rg1 cxb5 12. h4 Qg6 13. h5 Qg5 14. Qf3 Ng8 15. Bxf4 Qf6
16. Nc3 Bc5 17. Nd5 Qxb2 18. Bd6 Bxg1 19. e5 Qxa1+ 20. Ke2 Na6 21. Nxg7+ Kd8
22. Qf6+ Nxf6 23. Be7# 1-0`;

            const temp = new Chess();
            if (temp.load_pgn(pgn)) {
                game = temp;
                isImmortalGame = true;
                history = [];
                const rebuild = new Chess();
                history.push(rebuild.fen());
                game.history().forEach(m => {
                    rebuild.move(m);
                    history.push(rebuild.fen());
                });
                currentIndex = history.length - 1;
                playerSide = document.getElementById('side-select').value;
                initBoard(playerSide === 'w' ? 'white' : 'black');
                updateNavButtons();
                updateStatus();
            }
        });

        document.getElementById('save-pgn-btn').addEventListener('click', () => {
            const temp = new Chess();
            temp.load_pgn(game.pgn());
            const pgn = temp.pgn({ max_width: 80, newline_char: '\n' });
            const blob = new Blob([pgn || ''], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `escacs_${new Date().toISOString().slice(0,10)}.pgn`;
            a.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById('load-pgn-file').addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                const temp = new Chess();
                if (temp.load_pgn(ev.target.result)) {
                    game = temp;
                    isImmortalGame = false;
                    history = [];
                    const rebuild = new Chess();
                    history.push(rebuild.fen());
                    game.history().forEach(m => {
                        rebuild.move(m);
                        history.push(rebuild.fen());
                    });
                    currentIndex = history.length - 1;
                    playerSide = document.getElementById('side-select').value;
                    initBoard(playerSide === 'w' ? 'white' : 'black');
                    updateNavButtons();
                    updateStatus();
                    if (game.turn() !== playerSide && !game.game_over()) makeAIMove();
                } else {
                    alert('Error carregant PGN');
                }
            };
            reader.readAsText(file);
        });

        // Navigation
        document.getElementById('start-btn').addEventListener('click', () => goToIndex(0));
        document.getElementById('prev-btn').addEventListener('click', () => goToIndex(currentIndex - 1));
        document.getElementById('next-btn').addEventListener('click', () => {
            if (currentIndex < history.length - 1) {
                goToIndex(currentIndex + 1);
            } else if (!game.game_over() && game.turn() !== playerSide) {
                makeAIMove();
            }
        });
        document.getElementById('end-btn').addEventListener('click', () => goToIndex(history.length - 1));

        // Promotion choice
        document.querySelectorAll('.promotion-piece').forEach(el => {
            el.addEventListener('click', () => {
                if (!pendingPromotion) return;
                const { source, target } = pendingPromotion;
                const promotion = el.dataset.piece;

                const move = game.move({
                    from: source,
                    to: target,
                    promotion: promotion
                });

                if (move) {
                    history.push(game.fen());
                    currentIndex = history.length - 1;
                    board.position(game.fen(), true);
                    updateNavButtons();
                    updateStatus();
                    makeAIMove();
                }

                document.getElementById('promotion-modal').style.display = 'none';
                pendingPromotion = null;
            });
        });

        // Resize handling
        function resizeBoard() { if (board) board.resize(); }
        window.addEventListener('resize', resizeBoard);
        window.addEventListener('orientationchange', resizeBoard);

        // Inicialitza el motor Stockfish
        initEngine();

        // Initial start
        startNewGame();
    </script>
</body>
</html>












