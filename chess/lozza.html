<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <title>Escacs Lozza.js</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        /* Estil general */
        body {
            background: #1a1a1a;
            color: white;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0;
            margin: 0;
            height: 100vh;
        }

        /* Tauler d'escacs responsiu i quadrat */
        #board {
            width: 90vw;       /* 90% de l'amplada de la finestra */
            max-width: 600px;  /* màxim 600px en PC */
            aspect-ratio: 1;   /* manté quadrat */
            border: 2px solid #555;
            margin-top: 10px;
        }

        /* Panel amb botons i estat del joc */
        .panel {
            width: 90vw;
            max-width: 600px;
            background: #222;
            padding: 15px;
            border-radius: 0 0 8px 8px;
            box-sizing: border-box;
            margin-top: 10px;
        }

        .status {
            color: #2ecc71;
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
        }

        #error-log {
            background: #fee;
            color: #b71c1c;
            padding: 10px;
            border-radius: 4px;
            display: none;
            margin-top: 10px;
            font-size: 13px;
        }

        button {
            width: 100%;
            padding: 8px;
            cursor: pointer;
            background: #2ecc71;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            color: #000;
        }

        button:hover {
            background: #27ae60;
        }
    </style>
</head>
<body>

    <div id="board"></div>

    <div class="panel">
        <div id="status" class="status">Carregant motor intern...</div>
        <div id="error-log"></div>
        <button onclick="location.reload()">Reiniciar Joc</button>
    </div>

    <!-- Llibreries necessàries -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

    <script>
        const game = new Chess();
        let board = null;
        let engineWorker = null;

        /* Funció per mostrar errors */
        function showError(msg) {
            const el = document.getElementById('error-log');
            el.innerText = msg;
            el.style.display = 'block';
        }

        /* Inicialitza el motor Lozza (o qualsevol motor JS que tinguis) */
        const engineUrl = "lozza.js"; // Assegura't de tenir aquest fitxer

        function initEngine() {
            try {
                engineWorker = new Worker(engineUrl);

                engineWorker.onmessage = function(e) {
                    const line = e.data;
                    if (line.indexOf('bestmove') > -1) {
                        const match = line.match(/bestmove\s([a-h][1-8][a-h][1-8])/);
                        if (match) {
                            const move = match[1];
                            game.move({ from: move.substring(0,2), to: move.substring(2,4), promotion: 'q' });
                            board.position(game.fen());
                            document.getElementById('status').innerText = "Teu torn (Blanques)";
                        }
                    }
                };

                engineWorker.postMessage('uci');
                document.getElementById('status').innerText = "Motor a punt! Fes el teu moviment.";
            } catch (e) {
                showError("Error en iniciar el motor: " + e.message);
            }
        }

        /* Funció quan es mou una peça */
        function onDrop(source, target) {
            const move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';

            document.getElementById('status').innerText = "L'ordinador està pensant...";

            setTimeout(() => {
                engineWorker.postMessage('position fen ' + game.fen());
                engineWorker.postMessage('go depth 10');
            }, 250);
        }

        /* Inicialitza el tauler */
        board = ChessBoard('board', {
            draggable: true,
            position: 'start',
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
            onDrop: onDrop,
            onSnapEnd: () => board.position(game.fen())
        });

        initEngine();

        /* Funció per fer el tauler responsiu */
        function resizeBoard() {
            const boardEl = document.getElementById('board');
            const size = Math.min(window.innerWidth * 0.9, 600);
            boardEl.style.width = size + 'px';
            boardEl.style.height = size + 'px';
            if (board) board.resize();
        }

        window.addEventListener('resize', resizeBoard);
        resizeBoard(); // Inicialitza la mida al carregar
    </script>
</body>
</html>
