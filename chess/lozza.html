<!<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <title>Escacs Incorruptibles - Neocities</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        #board { width: 400px; max-width: 90vw; border: 2px solid #555; }
        .panel { width: 400px; background: #222; padding: 15px; border-radius: 0 0 8px 8px; box-sizing: border-box; }
        .status { color: #2ecc71; text-align: center; font-weight: bold; margin-bottom: 10px; }
        #error-log { background: #fee; color: #b71c1c; padding: 10px; border-radius: 4px; display: none; margin-top: 10px; font-size: 13px; }
    </style>
</head>
<body>

    <div id="board"></div>
    <div class="panel">
        <div id="status" class="status">Carregant motor intern...</div>
        <div id="error-log"></div>
        <button onclick="location.reload()" style="width:100%; padding:8px; cursor:pointer;">Reiniciar Joc</button>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

    <script>
        const game = new Chess();
        let board = null;
        let engineWorker = null;

        // ERROR HANDLING
        function showError(msg) {
            const el = document.getElementById('error-log');
            el.innerText = msg;
            el.style.display = 'block';
        }

        // MOTOR INTEGRAT (Lozza - un motor petit però fort en JS)
        // En lloc de carregar un fitxer, creem el Worker des d'una URL de script externa directa que Neocities accepti millor
        const engineUrl = "lozza.js"; 

        function initEngine() {
            try {
                // Truc: Carreguem Lozza des d'un repositori de GitHub Pages (molt més estable que CDNJS per a Neocities)
                engineWorker = new Worker(engineUrl);

                engineWorker.onmessage = function(e) {
                    const line = e.data;
                    if (line.indexOf('bestmove') > -1) {
                        const match = line.match(/bestmove\s([a-h][1-8][a-h][1-8])/);
                        if (match) {
                            const move = match[1];
                            game.move({ from: move.substring(0,2), to: move.substring(2,4), promotion: 'q' });
                            board.position(game.fen());
                            document.getElementById('status').innerText = "Teu torn (Blanques)";
                        }
                    }
                };

                engineWorker.postMessage('uci');
                document.getElementById('status').innerText = "Motor a punt! Fes el teu moviment.";
            } catch (e) {
                showError("Error en iniciar el motor: " + e.message);
            }
        }

        function onDrop(source, target) {
            const move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';

            document.getElementById('status').innerText = "L'ordinador està pensant...";
            
            setTimeout(() => {
                engineWorker.postMessage('position fen ' + game.fen());
                engineWorker.postMessage('go depth 10');
            }, 250);
        }

        board = ChessBoard('board', {
            draggable: true,
            position: 'start',
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
            onDrop: onDrop,
            onSnapEnd: () => board.position(game.fen())
        });

        initEngine();

    </script>
</body>
</html>
