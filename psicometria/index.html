<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Análisis Psicométrico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: "Segoe UI", sans-serif; margin: 2rem; background: #f5f7fa; color: #333; }
    h2 { color: #222; }
    input, textarea, button { font-size: 1rem; margin-bottom: 1rem; width: 100%; }
    textarea { height: 120px; resize: vertical; padding: 0.5rem; }
    button {
      padding: 0.7rem; border: none; border-radius: 5px; cursor: pointer;
    }
    button.primary { background: #007bff; color: white; }
    button.secondary { background: #28a745; color: white; }
    button.export { background: #6c757d; color: white; }
    button:hover { opacity: 0.9; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #e9ecef; }
    .flex { display: flex; gap: 1rem; flex-wrap: wrap; }
    .half { flex: 1 1 48%; }
    @media (max-width: 768px) { .half { flex: 1 1 100%; } }
    #modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); }
    #modal-content {
      background-color: white; margin: 5% auto; padding: 2rem; width: 90%; max-width: 700px;
      border-radius: 10px; position: relative; overflow-y: auto; max-height: 90%;
    }
    .close { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; }
    .chart-container { width: 100%; max-width:700px; margin:2rem auto 0 auto; background:white; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.09);}
  </style>
</head>
<body>
  <h2>Análisis Psicométrico de Ítems (0/1)</h2>

  <div class="flex">
    <div class="half">
      <label><strong>Sube archivo CSV:</strong></label>
      <input type="file" accept=".csv" id="csvFile" />
    </div>
    <div class="half">
      <label><strong>O escribe los datos (0 o 1):</strong></label>
      <textarea id="manualInput" placeholder="Ejemplo:&#10;1,0,1,0&#10;0,1,1,1"></textarea>
    </div>
  </div>

  <div class="flex">
    <div class="half">
      <button class="primary" onclick="analyze()">Analizar</button>
    </div>
    <div class="half">
      <button class="secondary" onclick="showModal()">Ayuda / Conceptos</button>
    </div>
  </div>

  <div class="flex" style="margin-top: 1rem;">
    <div class="half">
      <button class="export" onclick="exportToExcel()">Exportar a Excel</button>
    </div>
    <div class="half">
      <button class="export" onclick="exportToPDF()">Exportar a PDF</button>
    </div>
  </div>

  <div id="results"></div>
  <div class="chart-container">
    <canvas id="psychChart"></canvas>
  </div>

  <!-- Modal -->
  <div id="modal">
    <div id="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3>Ayuda y Conceptos Psicométricos</h3>
      <p><strong>Dificultad (p):</strong> proporción de participantes que aciertan el ítem. Valores altos = ítem fácil.</p>
      <p><strong>Discriminación (rpbi):</strong> correlación entre el ítem y la puntuación total. Mide cómo el ítem diferencia entre estudiantes con alto y bajo rendimiento. Valores &gt;0.2 son buenos.</p>
      <p><strong>Punt-Biserial:</strong> Es una medida específica de discriminación para ítems dicotómicos. En este código se emplea una aproximación equivalente mediante correlación simple.</p>
      <p><strong>Alpha de Cronbach:</strong> Medida de consistencia interna del test. Valores:
        <ul>
          <li>&gt; 0.90: Excelente</li>
          <li>&gt; 0.80: Buena</li>
          <li>&gt; 0.70: Aceptable</li>
          <li>&lt; 0.70: Baja</li>
        </ul>
      </p>
      <p><strong>Formato esperado:</strong> Archivo CSV o entrada manual con filas (participantes) y columnas (ítems). Todas las celdas deben ser 0 (respuesta incorrecta) o 1.(respuesta correctas).</p>
    </div>
  </div>

  <!-- Bibliotecas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.1/jspdf.umd.min.js" integrity="sha512-ad3j5/L4h648YM/KObaUfjCsZRBP9sAOmpjaT2BDx6u9aBrKFp7SbeHykruy83rxfmG42+5QqeL/ngcojglbJw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/5.0.2/jspdf.plugin.autotable.min.js" integrity="sha512-JizZOUNesiGhMcp9fsA/9W31FOat6QysBM8hSj6ir8iIANIUJ2mhko7Lo1+j0ErftmJ8SebMZLm9iielKjeIEQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    let resultatsGlobals = [];
    let psychChart = null;

    function parseCSV(text) {
      return text.trim().split('\n').map(row =>
        row.split(',').map(cell => {
          const val = Number(cell.trim());
          return (val === 0 || val === 1) ? val : NaN;
        })
      );
    }

    function columnMeans(data) {
      const cols = data[0].length;
      return Array.from({ length: cols }, (_, j) =>
        data.reduce((sum, row) => sum + row[j], 0) / data.length
      );
    }

    function columnCorrelations(data) {
      const n = data.length;
      const cols = data[0].length;
      const totalScores = data.map(row => row.reduce((a, b) => a + b));
      const meanTotal = totalScores.reduce((a, b) => a + b, 0) / n;
      const stdTotal = Math.sqrt(totalScores.reduce((s, x) => s + Math.pow(x - meanTotal, 2), 0) / n);

      return Array.from({ length: cols }, (_, j) => {
        const x = data.map(row => row[j]);
        const meanX = x.reduce((a, b) => a + b, 0) / n;
        const stdX = Math.sqrt(x.reduce((s, xi) => s + Math.pow(xi - meanX, 2), 0) / n);
        const cov = x.reduce((s, xi, i) => s + (xi - meanX) * (totalScores[i] - meanTotal), 0) / n;
        if (stdX > 0 && stdTotal > 0) return (cov / (stdX * stdTotal));
        else return 0;
      });
    }

    function cronbachAlpha(data) {
      const nItems = data[0].length;
      const nStudents = data.length;
      const itemVars = Array.from({ length: nItems }, (_, j) => {
        const values = data.map(row => row[j]);
        const mean = values.reduce((a, b) => a + b, 0) / nStudents;
        return values.reduce((s, x) => s + Math.pow(x - mean, 2), 0) / nStudents;
      });
      const totalScores = data.map(row => row.reduce((a, b) => a + b));
      const meanTotal = totalScores.reduce((a, b) => a + b, 0) / nStudents;
      const varTotal = totalScores.reduce((s, x) => s + Math.pow(x - meanTotal, 2), 0) / nStudents;
      if (varTotal === 0) return 0;
      const sumItemVars = itemVars.reduce((a, b) => a + b, 0);
      return (nItems / (nItems - 1)) * (1 - (sumItemVars / varTotal));
    }

    function analyze() {
      let text = '';
      const file = document.getElementById('csvFile').files[0];
      const manual = document.getElementById('manualInput').value.trim();

      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          text = e.target.result;
          process(text);
        };
        reader.readAsText(file);
      } else if (manual) {
        text = manual;
        process(text);
      } else {
        alert("Introduce datos o sube un archivo CSV.");
      }
    }

    function process(text) {
      let data = parseCSV(text);
      const originalLength = data.length;
      data = data.filter(row => row.length === data[0].length && row.every(val => val === 0 || val === 1));
      if (data.length < originalLength) {
        alert(`Se han descartado ${originalLength - data.length} filas con valores inválidos.`);
      }
      if (!data.length || data[0].length < 2) {
        document.getElementById('results').innerHTML = "<p style='color:red'>Datos inválidos.</p>";
        return;
      }
      const itemNames = Array.from({ length: data[0].length }, (_, i) => `Q${i + 1}`);
      const pValues = columnMeans(data);
      const correlations = columnCorrelations(data);
      const alpha = cronbachAlpha(data);
      resultatsGlobals = itemNames.map((name, i) => ({
        Ítem: name,
        Dificultad: pValues[i],
        Discriminación: correlations[i]
      }));
      let html = '<table><tr><th>Ítem</th><th>Dificultad (p)</th><th>Discriminación (rpbi)</th></tr>';
      resultatsGlobals.forEach(row => {
        html += `<tr><td>${row.Ítem}</td><td>${row.Dificultad.toFixed(2)}</td><td>${row.Discriminación.toFixed(2)}</td></tr>`;
      });
      html += '</table>';
      html += `<p><strong>Alpha de Cronbach:</strong> ${alpha.toFixed(3)}</p>`;
      resultatsGlobals.alpha = alpha.toFixed(3);
      document.getElementById('results').innerHTML = html;
      drawChart(resultatsGlobals);
    }

    function drawChart(resultats) {
      const ctx = document.getElementById('psychChart').getContext('2d');
      if (psychChart) psychChart.destroy();
      psychChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: resultats.map(r => r.Ítem),
          datasets: [
            {
              label: 'Dificultad (p)',
              data: resultats.map(r => +r.Dificultad.toFixed(2)),
              backgroundColor: 'rgba(0, 123, 255, 0.65)'
            },
            {
              label: 'Discriminación (rpbi)',
              data: resultats.map(r => +r.Discriminación.toFixed(2)),
              backgroundColor: 'rgba(40, 167, 69, 0.65)'
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: {
              display: true,
              text: 'Dificultad y Discriminación por Ítem'
            }
          },
          scales: {
            y: { min: 0, max: 1, title: { display: true, text: 'Valor' } }
          }
        }
      });
    }

    function exportToExcel() {
      if (!resultatsGlobals.length) return alert("Analiza datos antes de exportar.");
      const ws = XLSX.utils.json_to_sheet(resultatsGlobals.map(r => ({
        Ítem: r.Ítem,
        Dificultad: r.Dificultad.toFixed(2),
        Discriminación: r.Discriminación.toFixed(2)
      })));
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Resultados");
      XLSX.writeFile(wb, "analisis_psicometrico.xlsx");
    }

    function exportToPDF() {
      if (!resultatsGlobals.length) return alert("Analiza datos antes de exportar.");
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Análisis Psicométrico", 14, 15);
      const rows = resultatsGlobals.map(r => [r.Ítem, r.Dificultad.toFixed(2), r.Discriminación.toFixed(2)]);
      doc.autoTable({ head: [['Ítem', 'Dificultad', 'Discriminación']], body: rows, startY: 25 });
      doc.text(`Alpha de Cronbach: ${resultatsGlobals.alpha}`, 14, doc.lastAutoTable.finalY + 10);
      doc.save("analisis_psicometrico.pdf");
    }

    function showModal() { document.getElementById("modal").style.display = "block"; }
    function closeModal() { document.getElementById("modal").style.display = "none"; }
    window.onclick = e => { if (e.target == document.getElementById("modal")) closeModal(); };
  </script>
</body>
</html>
