<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>An√°lisis Psicom√©trico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: "Segoe UI", sans-serif; margin: 2rem; background: #f5f7fa; color: #333; }
    h2 { color: #222; }
    input, textarea, button { font-size: 1rem; margin-bottom: 1rem; width: 100%; }
    textarea { height: 120px; resize: vertical; padding: 0.5rem; }
    button {
      padding: 0.7rem; border: none; border-radius: 5px; cursor: pointer;
    }
    button.primary { background: #007bff; color: white; }
    button.secondary { background: #28a745; color: white; }
    button.export { background: #6c757d; color: white; }
    button:hover { opacity: 0.9; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #e9ecef; }
    .flex { display: flex; gap: 1rem; flex-wrap: wrap; }
    .half { flex: 1 1 48%; }
    @media (max-width: 768px) { .half { flex: 1 1 100%; } }
    #modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); }
    #modal-content {
      background-color: white; margin: 5% auto; padding: 2rem; width: 90%; max-width: 700px;
      border-radius: 10px; position: relative; overflow-y: auto; max-height: 90%;
    }
    .close { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; }
    .chart-container { width: 100%; max-width:700px; margin:2rem auto 0 auto; background:white; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.09);}
    .notice { color:#a21a1a; font-weight:500; margin-bottom:1em;}
  </style>
</head>
<body>
  <h2>An√°lisis Psicom√©trico de √çtems (0/1)</h2>

  <div class="flex">
    <div class="half">
      <label><strong>Sube archivo CSV:</strong></label>
      <input type="file" accept=".csv" id="csvFile" />
    </div>
    <div class="half">
      <label><strong>O escribe los datos (0 o 1):</strong></label>
      <textarea id="manualInput" placeholder="Ejemplo:&#10;1,0,1,0&#10;0,1,1,1"></textarea>
    </div>
  </div>

  <div class="flex">
    <div class="half">
      <button class="primary" onclick="analyze()">Analizar</button>
    </div>
    <div class="half">
      <button class="secondary" onclick="showModal()">Ayuda / Conceptos</button>
    </div>
  </div>

  <div class="flex" style="margin-top: 1rem;">
    <div class="half">
      <button class="export" onclick="exportToExcel()">Exportar a Excel</button>
    </div>
    <div class="half">
      <button class="export" onclick="exportToPDF()">Exportar a PDF</button>
    </div>
  </div>

  <div id="results"></div>
  <div class="chart-container">
    <canvas id="psychChart"></canvas>
  </div>

  <!-- Modal -->
<div id="modal">
  <div id="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3>üìä Gu√≠a de Interpretaci√≥n Psicom√©trica</h3>

    <p><strong>Dificultad del √çtem (p):</strong> Proporci√≥n de estudiantes que respondieron correctamente.</p>
    <ul>
      <li>Rango: 0 a 1.</li>
      <li><strong>p &lt; 0.20:</strong> Muy dif√≠cil</li>
      <li><strong>p &gt; 0.80:</strong> Muy f√°cil</li>
      <li>Ideal: entre 0.30 y 0.70</li>
    </ul>

    <p><strong>Discriminaci√≥n (Correlaci√≥n Punto-Biserial Corregida):</strong></p>
    <ul>
      <li>Mide la capacidad del √≠tem para diferenciar entre estudiantes con alto y bajo rendimiento.</li>
      <li><strong>pbis &gt; 0.30:</strong> Buena discriminaci√≥n</li>
      <li><strong>pbis &lt; 0.20:</strong> √çtem poco informativo</li>
    </ul>

    <p><strong>Alpha de Cronbach (Œ±):</strong> Estimador de la consistencia interna del test (fiabilidad).</p>
    <ul>
      <li><strong>Œ± ‚â• 0.90:</strong> Excelente</li>
      <li><strong>0.80 ‚â§ Œ± &lt; 0.90:</strong> Buena</li>
      <li><strong>0.70 ‚â§ Œ± &lt; 0.80:</strong> Aceptable</li>
      <li><strong>Œ± &lt; 0.70:</strong> Mejorable</li>
    </ul>

    <p><strong>Formato de Entrada Esperado:</strong></p>
    <ul>
      <li>Archivo <code>.csv</code> o entrada manual</li>
      <li>Filas = Estudiantes, Columnas = √çtems</li>
      <li>Solo valores 0 (incorrecto) o 1 (correcto)</li>
    </ul>

    <p><strong>Consejo:</strong> Revise √≠tems con p &lt; 0.30 o pbis &lt; 0.20. Podr√≠an estar mal redactados o no alineados con los objetivos de aprendizaje.</p>
  </div>
</div>

  <!-- Bibliotecas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script>
    let resultatsGlobals = [];
    let psychChart = null;

    function parseCSV(text) {
      return text.trim().split('\n').map(row =>
        row.split(',').map(cell => {
          const val = Number(cell.trim());
          return (val === 0 || val === 1) ? val : NaN;
        })
      );
    }

    function columnMeans(data) {
      const cols = data[0].length;
      return Array.from({ length: cols }, (_, j) =>
        data.reduce((sum, row) => sum + row[j], 0) / data.length
      );
    }

    // NUEVO: punto biserial corregido (pbis)
    function puntoBiserialCorregido(data, col) {
      const n = data.length;
      const p = data.filter(r => r[col] === 1).length / n;
      const q = 1 - p;
      if (p === 0 || q === 0) return 0; // Sin variabilidad no hay discriminaci√≥n
      // Puntuaci√≥n total sin el √≠tem actual
      const totalesSinItem = data.map(row =>
        row.reduce((suma, x, j) => j !== col ? suma + x : suma, 0)
      );
      const aciertan = totalesSinItem.filter((_, idx) => data[idx][col] === 1);
      const fallan = totalesSinItem.filter((_, idx) => data[idx][col] === 0);
      const mean1 = aciertan.length ? aciertan.reduce((a,b)=>a+b,0)/aciertan.length : 0;
      const mean0 = fallan.length ? fallan.reduce((a,b)=>a+b,0)/fallan.length : 0;
      const meanT = totalesSinItem.reduce((a,b)=>a+b,0)/n;
      const stdT = Math.sqrt(totalesSinItem.reduce((a,b)=>a+Math.pow(b-meanT,2),0)/n);
      return stdT === 0 ? 0 : ((mean1 - mean0) / stdT) * Math.sqrt(p * q);
    }

    function cronbachAlpha(data) {
      const nItems = data[0].length;
      const nStudents = data.length;
      const itemVars = Array.from({ length: nItems }, (_, j) => {
        const values = data.map(row => row[j]);
        const mean = values.reduce((a, b) => a + b, 0) / nStudents;
        return values.reduce((s, x) => s + Math.pow(x - mean, 2), 0) / nStudents;
      });
      const totalScores = data.map(row => row.reduce((a, b) => a + b));
      const meanTotal = totalScores.reduce((a, b) => a + b, 0) / nStudents;
      const varTotal = totalScores.reduce((s, x) => s + Math.pow(x - meanTotal, 2), 0) / nStudents;
      if (varTotal === 0) return 0;
      const sumItemVars = itemVars.reduce((a, b) => a + b, 0);
      return (nItems / (nItems - 1)) * (1 - (sumItemVars / varTotal));
    }

    function analyze() {
      let text = '';
      const file = document.getElementById('csvFile').files[0];
      const manual = document.getElementById('manualInput').value.trim();

      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          text = e.target.result;
          process(text);
        };
        reader.readAsText(file);
      } else if (manual) {
        text = manual;
        process(text);
      } else {
        alert("Introduce datos o sube un archivo CSV.");
      }
    }

    function process(text) {
      let data = parseCSV(text);
      const originalLength = data.length;
      // Validaci√≥n estricta: si hay alg√∫n NaN, error y explicaci√≥n
      for (let i = 0; i < data.length; i++) {
        for (let j = 0; j < data[i].length; j++) {
          if (isNaN(data[i][j])) {
            document.getElementById('results').innerHTML = `<p class="notice">Error: dato no v√°lido (solo 0 o 1) en la fila ${i+1}, columna ${j+1}.</p>`;
            return;
          }
        }
      }
      data = data.filter(row => row.length === data[0].length && row.every(val => val === 0 || val === 1));
      if (!data.length || data[0].length < 2) {
        document.getElementById('results').innerHTML = "<p style='color:red'>Datos inv√°lidos.</p>";
        return;
      }
      const itemNames = Array.from({ length: data[0].length }, (_, i) => `Q${i + 1}`);
      const pValues = columnMeans(data);
      const pbisValues = Array.from({ length: data[0].length }, (_, j) => puntoBiserialCorregido(data, j));
      const alpha = cronbachAlpha(data);
      resultatsGlobals = itemNames.map((name, i) => ({
        √çtem: name,
        Dificultad: pValues[i],
        Discriminaci√≥n: pbisValues[i]
      }));
      let html = '<table><tr><th>√çtem</th><th>Dificultad (p)</th><th>Discriminaci√≥n (pbis)</th></tr>';
      resultatsGlobals.forEach(row => {
        html += `<tr><td>${row.√çtem}</td><td>${row.Dificultad.toFixed(2)}</td><td>${row.Discriminaci√≥n.toFixed(2)}</td></tr>`;
      });
      html += '</table>';
      html += `<p><strong>Alpha de Cronbach:</strong> ${alpha.toFixed(3)}</p>`;
      resultatsGlobals.alpha = alpha.toFixed(3);
      document.getElementById('results').innerHTML = html;
      drawChart(resultatsGlobals);
    }

    function drawChart(resultats) {
      const ctx = document.getElementById('psychChart').getContext('2d');
      if (psychChart) psychChart.destroy();
      psychChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: resultats.map(r => r.√çtem),
          datasets: [
            {
              label: 'Dificultad (p)',
              data: resultats.map(r => +r.Dificultad.toFixed(2)),
              backgroundColor: 'rgba(0, 123, 255, 0.65)'
            },
            {
              label: 'Discriminaci√≥n (pbis)',
              data: resultats.map(r => +r.Discriminaci√≥n.toFixed(2)),
              backgroundColor: 'rgba(40, 167, 69, 0.65)'
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: {
              display: true,
              text: 'Dificultad y Discriminaci√≥n por √çtem'
            }
          },
          scales: {
            y: { min: 0, max: 1, title: { display: true, text: 'Valor' } }
          }
        }
      });
    }

    function exportToExcel() {
      if (!resultatsGlobals.length) return alert("Analiza datos antes de exportar.");
      const ws = XLSX.utils.json_to_sheet(resultatsGlobals.map(r => ({
        √çtem: r.√çtem,
        Dificultad: r.Dificultad.toFixed(2),
        Discriminaci√≥n: r.Discriminaci√≥n.toFixed(2)
      })));
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Resultados");
      XLSX.writeFile(wb, "analisis_psicometrico.xlsx");
    }

    function exportToPDF() {
      if (!resultatsGlobals.length) return alert("Analiza datos antes de exportar.");
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("An√°lisis Psicom√©trico", 14, 15);
      const rows = resultatsGlobals.map(r => [r.√çtem, r.Dificultad.toFixed(2), r.Discriminaci√≥n.toFixed(2)]);
      doc.autoTable({ head: [['√çtem', 'Dificultad', 'Discriminaci√≥n']], body: rows, startY: 25 });
      doc.text(`Alpha de Cronbach: ${resultatsGlobals.alpha}`, 14, doc.lastAutoTable.finalY + 10);
      doc.save("analisis_psicometrico.pdf");
    }

    function showModal() { document.getElementById("modal").style.display = "block"; }
    function closeModal() { document.getElementById("modal").style.display = "none"; }
    window.onclick = e => { if (e.target == document.getElementById("modal")) closeModal(); };
  </script>
</body>
</html>
